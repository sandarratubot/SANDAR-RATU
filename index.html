<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SANDAR-RATU - Sistem Administrasi & Dokumen Kesyahbandaran</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Login Styles */
        .login-container {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            overflow: hidden;
        }

        .logo-section {
            text-align: center;
            padding: 40px 30px 20px;
            background: linear-gradient(135deg, #3498db, #1a73e8);
        }

        .logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            text-decoration: none;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: #fff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3498db;
        }

        .warning-section {
            background: #feffd6;
            border: 1px solid #fff4ce;
            margin: 20px;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .warning-title {
            background: #ffffff;
            border: 1px solid #ffeaa7;
            color: #000000;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 15px;
            display: inline-block;
        }

        .warning-text {
            color: #000000;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .login-method-section {
            padding: 20px;
            text-align: center;
        }

        .method-title {
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 15px;
            font-style: italic;
        }

        .google-login-btn {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            background: #fff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .google-login-btn:hover {
            border-color: #1a73e8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .google-login-btn:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .google-icon {
            width: 18px;
            height: 18px;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        .header {
            background: #2c3e50;
            color: white;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .header .logo-icon {
            background: #3498db;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #3498db;
        }

        .main-container {
            display: flex;
            flex: 1;
        }

        .sidebar {
            width: 240px;
            background: #3498db;
            color: white;
            padding-top: 20px;
            overflow-y: auto;
        }

        .sidebar div {
            padding: 8px 20px;
            font-weight: 600;
            opacity: 0.8;
            font-size: 13px;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: 0.3s;
            cursor: pointer;
        }

        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar a.active {
            background: rgba(0, 0, 0, 0.25);
            font-weight: bold;
        }

        .content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #f5f5f5;
        }

        .content h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .form-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .form-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-control {
            flex: 1;
        }

        .form-control {
            width: 100%;
            margin-bottom: 15px;
        }

        .form-control label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-control input, .form-control select, .form-control textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-control textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .btn-generate {
            width: 100%;
            padding: 12px;
            background: #2ecc71;
            border: none;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .btn-generate:hover {
            background: #27ae60;
        }

        .btn-generate:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .btn-upload-drive {
            width: 100%;
            padding: 12px;
            background: #1a73e8;
            border: none;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .btn-upload-drive:hover:not(:disabled) {
            background: #1557b0;
        }

        .btn-upload-drive:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-logout {
            background: #e74c3c;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
        }

        .result-container {
            margin-top: 15px;
        }

        .form-type-indicator {
            background: #e8f4f8;
            border: 2px solid #3498db;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .form-type-indicator h3 {
            color: #2c3e50;
            margin: 0;
        }

        .content-page {
            display: none;
        }

        .content-page.active {
            display: block;
        }

        .upload-status {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }

        .upload-error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }

        .google-drive-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1565c0;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
        }

        .footer-login {
            text-align: center;
            padding: 15px;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
        }

        .processing-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1565c0;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }

        /* Error handling styles */
        .error-message {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success-message {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* Loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Document selection styles */
        .doc-selection-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #dee2e6;
        }

        .doc-selection-header h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .select-all-container {
            margin-bottom: 15px;
        }

        .select-all-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .select-all-btn:hover {
            background: #138496;
        }
    </style>
</head>
<body>

<div id="loginPage" class="login-container">
    <div class="logo-section">
        <a href="#" class="logo">
            <div class="logo-icon">
                <i class="fas fa-anchor"></i>
            </div>
            SANDAR-RATU
        </a>
    </div>

    <div class="warning-section">
        <div class="warning-title">Peringatan</div>
        <div class="warning-text">
            Halaman ini memerlukan autentikasi.<br>
            Silahkan klik tombol login di bawah untuk melanjutkan.<br>
            Terima kasih.
        </div>
    </div>

    <div class="login-method-section">
        <div class="method-title">- pilih metode login -</div>
        <button id="googleLoginBtn" class="google-login-btn">
            <svg class="google-icon" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Log in with Google
        </button>
    </div>

    <div class="footer-login">Hak Cipta ¬© 2025 Sandar-Ratu</div>
</div>

<div id="dashboard" class="dashboard">
    <div class="header">
        <div style="display:flex;align-items:center;">
            <div class="logo-icon"><i class="fas fa-anchor"></i></div>
            <strong>SANDAR-RATU</strong>
        </div>
        <div style="display:flex;align-items:center;gap:15px;">
            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="User">
                <span id="userName">User</span>
            </div>
            <button class="btn-logout" onclick="logout()">Keluar</button>
        </div>
    </div>
    <div class="main-container">
        <div class="sidebar">
            <div>üë®‚Äç‚úàÔ∏è PETUGAS</div>
            <a onclick="showPage('departurePetugas', this)"><i class="fas fa-ship"></i>&nbsp; Keberangkatan</a>
            <a onclick="showPage('arrivalPetugas', this)"><i class="fas fa-anchor"></i>&nbsp; Kedatangan</a>
            <div>üö¢ NELAYAN</div>
            <a onclick="showPage('departureNelayan', this)"><i class="fas fa-fish"></i>&nbsp; Keberangkatan</a>
            <a onclick="showPage('arrivalNelayan', this)"><i class="fas fa-water"></i>&nbsp; Kedatangan</a>
        </div>

        <div class="content" id="mainContent"></div>
    </div>
</div>

<script>
    const CLIENT_ID = "800620913330-fahu605bu7d8v877pbgaijvp0shrc3cf.apps.googleusercontent.com";
    const API_KEY = "AIzaSyDvNWYW_BNTF-sftpmff3jWyL9BeP6-qMg";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    const FOLDER_MAP = {
        "Petugas-Keberangkatan": "1Ws2ctYHbdUD7Wza2ld4KxO0j7fiFcg3o",
        "Petugas-Kedatangan": "1BIDQw9AMiY5_Mxt1OBKC1Lce3xzjtfTz",
        "Nelayan-Keberangkatan": "1bnyimhbu884iAdNX75u_MxtPN2azgAFy",
        "Nelayan-Kedatangan": "1Yt_-nTkJrZNO7Y2ZlBJIqebnMu0ncE-M"
    };

    // Document definitions
    const DOCUMENT_FORMS = {
        petugasKeberangkatan: [
            { id: 'spb', name: 'SPB (Surat Persetujuan Berlayar)', fields: ['noSPB', 'validUntil'] },
            { id: 'crewList', name: 'Crew List', fields: ['totalCrew', 'crewNames'] },
            { id: 'perbekalan', name: 'Perbekalan', fields: ['jenisPerbekalan', 'jumlah'] },
            { id: 'slo', name: 'SLO (Surat Laik Operasi)', fields: ['noSLO', 'berlakuSampai'] },
            { id: 'pernyataanNakhoda', name: 'Pernyataan Nakhoda', fields: ['pernyataan'] },
            { id: 'kwitansiTambat', name: 'Kwitansi Tambat Labuh', fields: ['noKwitansi', 'biayaTambat'] },
            { id: 'permohonanSPB', name: 'Permohonan Penerbitan SPB', fields: ['alasanPermohonan'] },
            { id: 'daftarABK', name: 'Daftar ABK dari Nahkoda', fields: ['jumlahABK', 'namaABK'] },
            { id: 'stblkk', name: 'STBLKK', fields: ['noSTBLKK', 'jenisIkan'] },
            { id: 'fakturBBM', name: 'Faktur BBM (non subsidi)', fields: ['jenisBBM', 'jumlahLiter', 'harga'] }
        ],
        petugasKedatangan: [
            { id: 'stblkk', name: 'STBLKK', fields: ['noSTBLKK', 'jenisIkan', 'jumlahTangkapan'] },
            { id: 'rekomBongkar', name: 'Rekom Bongkar', fields: ['noRekom', 'lokasiPenurunan'] },
            { id: 'spbAsal', name: 'SPB Asal', fields: ['noSPBAsal', 'pelabuhan'] }
        ],
        nelayanKeberangkatan: [
            { id: 'spb', name: 'SPB (Surat Persetujuan Berlayar)', fields: ['noSPB', 'validUntil'] },
            { id: 'crewList', name: 'Crew List', fields: ['totalCrew', 'crewNames'] },
            { id: 'perbekalan', name: 'Perbekalan', fields: ['jenisPerbekalan', 'jumlah'] },
            { id: 'slo', name: 'SLO (Surat Laik Operasi)', fields: ['noSLO', 'berlakuSampai'] },
            { id: 'pernyataanNakhoda', name: 'Pernyataan Nakhoda', fields: ['pernyataan'] }
        ],
        nelayanKedatangan: [
            { id: 'stblkk', name: 'STBLKK', fields: ['noSTBLKK', 'jenisIkan', 'jumlahTangkapan'] },
            { id: 'rekomBongkar', name: 'Rekom Bongkar', fields: ['noRekom', 'lokasiPenurunan'] },
            { id: 'spbAsal', name: 'SPB Asal', fields: ['noSPBAsal', 'pelabuhan'] }
        ]
    };

    let isGAPIReady = false;
    let currentUser = null;
    let currentAccessToken = null;
    let tokenClient = null;

    function showMessage(element, message, type = 'info') {
        const className = type === 'error' ? 'error-message' :
            type === 'success' ? 'success-message' : 'processing-status';
        element.className = className;
        element.innerHTML = message;
        element.style.display = 'block';
    }

    function hideMessage(element) {
        element.style.display = 'none';
    }

    function validateForm(form) {
        const shipName = form.querySelector('input[name="namaKapal"]')?.value?.trim();
        const date = form.querySelector('input[type="date"]')?.value;
        const time = form.querySelector('input[type="time"]')?.value;
        
        if (!shipName) throw new Error('Nama kapal harus diisi');
        if (!date) throw new Error('Tanggal harus diisi');
        if (!time) throw new Error('Waktu harus diisi');
        
        // Check if at least one document is selected
        const checkedDocs = form.querySelectorAll('input[type="checkbox"]:checked');
        if (checkedDocs.length === 0) throw new Error('Pilih minimal satu dokumen untuk digenerate');
        
        return true;
    }

    // Initialize Google APIs
    function initializeGoogle() {
        console.log('Initializing Google APIs...');
        
        try {
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true
            });
            console.log('Google Identity Services initialized');
        } catch (error) {
            console.error('Failed to initialize Google Identity Services:', error);
        }

        gapi.load('client', async () => {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                });

                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (response) => {
                        if (response.error !== undefined) {
                            console.error('Token client error:', response);
                            updateGoogleDriveStatus('Failed to get Drive access token');
                            return;
                        }
                        currentAccessToken = response.access_token;
                        console.log('Access token obtained successfully');
                        updateGoogleDriveStatus();
                    }
                });

                isGAPIReady = true;
                console.log('Google API Client initialized');
                updateGoogleDriveStatus();
            } catch (error) {
                console.error('Failed to initialize Google API Client:', error);
                updateGoogleDriveStatus('Error: Failed to connect to Google Drive');
            }
        });
    }

    function handleCredentialResponse(response) {
        if (!response.credential) {
            console.error('No credential received');
            return;
        }

        try {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            currentUser = {
                id: payload.sub,
                name: payload.name || 'User',
                email: payload.email || 'no-email',
                picture: payload.picture || ''
            };
            console.log('Login successful for:', currentUser.name);
            showDashboard();
        } catch (error) {
            console.error('Failed to parse credential:', error);
            alert('Login failed. Please try again.');
        }
    }

    document.getElementById('googleLoginBtn').addEventListener('click', () => {
        try {
            google.accounts.id.prompt();
        } catch (error) {
            console.error('Login error:', error);
            alert('Google login is not available. Please check your connection.');
        }
    });

    function showDashboard() {
        if (!currentUser) return;
        
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("dashboard").style.display = "flex";
        document.body.style.background = "white";
        
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userAvatar').src = currentUser.picture || '';
        
        initializePages();
        showPage('departurePetugas', document.querySelector(".sidebar a"));
    }

    function updateGoogleDriveStatus(errorMsg = null) {
        const statusElements = document.querySelectorAll('.google-drive-status');
        
        statusElements.forEach(el => {
            if (errorMsg) {
                el.className = 'upload-error';
                el.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMsg}`;
                disableUploadButtons();
            } else if (isGAPIReady) {
                if (currentAccessToken) {
                    el.className = 'upload-status';
                    el.innerHTML = '<i class="fas fa-check-circle"></i> Google Drive connected and ready';
                    enableUploadButtons();
                } else {
                    el.className = 'google-drive-status';
                    el.innerHTML = '<i class="fas fa-info-circle"></i> Click "Upload to Google Drive" to connect to Google Drive';
                    enableUploadButtons();
                }
            } else {
                el.className = 'google-drive-status';
                el.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting to Google Drive...';
                disableUploadButtons();
            }
        });
    }

    function enableUploadButtons() {
        document.querySelectorAll('.btn-upload-drive').forEach(btn => {
            btn.disabled = false;
        });
    }

    function disableUploadButtons() {
        document.querySelectorAll('.btn-upload-drive').forEach(btn => {
            btn.disabled = true;
        });
    }

    async function requestDrivePermission() {
        if (!tokenClient) {
            throw new Error('Google API not initialized');
        }

        return new Promise((resolve, reject) => {
            const originalCallback = tokenClient.callback;
            tokenClient.callback = (response) => {
                tokenClient.callback = originalCallback;
                if (response.error !== undefined) {
                    reject(new Error(response.error));
                } else {
                    currentAccessToken = response.access_token;
                    updateGoogleDriveStatus();
                    resolve(response.access_token);
                }
            };
            tokenClient.requestAccessToken();
        });
    }

    async function uploadToDrive(file, folderName) {
        if (!currentAccessToken) {
            await requestDrivePermission();
        }

        const folderId = FOLDER_MAP[folderName];
        if (!folderId) {
            throw new Error(`Folder '${folderName}' not found`);
        }

        const metadata = {
            name: file.name,
            parents: [folderId]
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], {
            type: 'application/json'
        }));
        form.append('file', file);

        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({
                'Authorization': `Bearer ${currentAccessToken}`
            }),
            body: form
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(`Upload failed: ${response.status} - ${error.error?.message || 'Unknown error'}`);
        }

        return await response.json();
    }

    function logout() {
        currentUser = null;
        currentAccessToken = null;
        
        if (currentAccessToken) {
            google.accounts.oauth2.revoke(currentAccessToken);
        }

        document.getElementById("loginPage").style.display = "flex";
        document.getElementById("dashboard").style.display = "none";
        document.body.style.background = "#f8f9fa";
        
        console.log('Logout successful');
    }

    function generateDocumentForm(documents, formType) {
        let formHtml = '';
        
        formHtml += `
            <div class="doc-selection-header">
                <h4><i class="fas fa-file-alt"></i> Pilih Dokumen yang akan Digenerate</h4>
                <div class="select-all-container">
                    <button type="button" class="select-all-btn" onclick="toggleSelectAll(this, '${formType}')">
                        Select All
                    </button>
                </div>
                <div class="checkbox-group" id="docGroup${formType}">
        `;
        
        documents.forEach((doc, index) => {
            formHtml += `
                <div class="checkbox-item">
                    <input type="checkbox" id="${doc.id}_${formType}" name="selectedDocs" value="${doc.id}">
                    <label for="${doc.id}_${formType}">${doc.name}</label>
                </div>
            `;
        });
        
        formHtml += `
                </div>
            </div>
        `;
        
        return formHtml;
    }

    function generateDocumentFields(documents, formType) {
        let fieldsHtml = '';
        
        documents.forEach((doc, index) => {
            fieldsHtml += `
                <div class="form-section" id="section_${doc.id}_${formType}" style="display: none;">
                    <h4><i class="fas fa-file"></i> ${doc.name}</h4>
            `;
            
            doc.fields.forEach(field => {
                const fieldLabel = getFieldLabel(field);
                const fieldType = getFieldType(field);
                
                if (fieldType === 'textarea') {
                    fieldsHtml += `
                        <div class="form-control">
                            <label for="${field}_${doc.id}_${formType}">${fieldLabel}</label>
                            <textarea id="${field}_${doc.id}_${formType}" name="${field}_${doc.id}" rows="3"></textarea>
                        </div>
                    `;
                } else {
                    fieldsHtml += `
                        <div class="form-control">
                            <label for="${field}_${doc.id}_${formType}">${fieldLabel}</label>
                            <input type="${fieldType}" id="${field}_${doc.id}_${formType}" name="${field}_${doc.id}">
                        </div>
                    `;
                }
            });
            
            fieldsHtml += '</div>';
        });
        
        return fieldsHtml;
    }

    function getFieldLabel(field) {
        const labels = {
            'noSPB': 'Nomor SPB',
            'validUntil': 'Berlaku Sampai',
            'totalCrew': 'Jumlah Crew',
            'crewNames': 'Nama-nama Crew',
            'jenisPerbekalan': 'Jenis Perbekalan',
            'jumlah': 'Jumlah',
            'noSLO': 'Nomor SLO',
            'berlakuSampai': 'Berlaku Sampai',
            'pernyataan': 'Isi Pernyataan',
            'noKwitansi': 'Nomor Kwitansi',
            'biayaTambat': 'Biaya Tambat (Rp)',
            'alasanPermohonan': 'Alasan Permohonan',
            'jumlahABK': 'Jumlah ABK',
            'namaABK': 'Nama-nama ABK',
            'noSTBLKK': 'Nomor STBLKK',
            'jenisIkan': 'Jenis Ikan',
            'jenisBBM': 'Jenis BBM',
            'jumlahLiter': 'Jumlah (Liter)',
            'harga': 'Harga Total (Rp)',
            'jumlahTangkapan': 'Jumlah Tangkapan (Kg)',
            'noRekom': 'Nomor Rekomendasi',
            'lokasiPenurunan': 'Lokasi Penurunan',
            'noSPBAsal': 'Nomor SPB Asal',
            'pelabuhan': 'Pelabuhan Asal'
        };
        return labels[field] || field;
    }

    function getFieldType(field) {
        const types = {
            'validUntil': 'date',
            'berlakuSampai': 'date',
            'totalCrew': 'number',
            'jumlah': 'number',
            'biayaTambat': 'number',
            'jumlahABK': 'number',
            'jumlahLiter': 'number',
            'harga': 'number',
            'jumlahTangkapan': 'number',
            'pernyataan': 'textarea',
            'alasanPermohonan': 'textarea',
            'crewNames': 'textarea',
            'namaABK': 'textarea'
        };
        return types[field] || 'text';
    }

    function toggleSelectAll(button, formType) {
        const checkboxes = document.querySelectorAll(`#docGroup${formType} input[type="checkbox"]`);
        const isSelectAll = button.textContent === 'Select All';
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = isSelectAll;
            toggleDocumentSection(checkbox, formType);
        });
        
        button.textContent = isSelectAll ? 'Deselect All' : 'Select All';
    }

    function toggleDocumentSection(checkbox, formType) {
        const docId = checkbox.value;
        const section = document.getElementById(`section_${docId}_${formType}`);
        
        if (section) {
            section.style.display = checkbox.checked ? 'block' : 'none';
        }
    }

    function generatePDF(formData, selectedDocs, formType) {
        const doc = new jspdf.jsPDF();
        let yPosition = 20;
        
        // Title
        const titleMap = {
            'departurePetugas': 'DOKUMEN KEBERANGKATAN PETUGAS',
            'arrivalPetugas': 'DOKUMEN KEDATANGAN PETUGAS', 
            'departureNelayan': 'DOKUMEN KEBERANGKATAN NELAYAN',
            'arrivalNelayan': 'DOKUMEN KEDATANGAN NELAYAN'
        };
        
        doc.setFontSize(16);
        doc.text(titleMap[formType] || 'DOKUMEN PELAYARAN', 105, yPosition, { align: 'center' });
        yPosition += 20;
        
        // Ship info
        doc.setFontSize(12);
        doc.text(`Nama Kapal: ${formData.namaKapal || ''}`, 20, yPosition);
        yPosition += 10;
        doc.text(`Nakhoda: ${formData.nakhoda || ''}`, 20, yPosition);
        yPosition += 10;
        doc.text(`Tanggal: ${formData.tanggal || ''}`, 20, yPosition);
        yPosition += 10;
        doc.text(`Waktu: ${formData.waktu || ''}`, 20, yPosition);
        yPosition += 15;
        
        // Documents
        selectedDocs.forEach(docId => {
            const docInfo = getDocumentInfo(docId, formType);
            if (docInfo) {
                doc.setFontSize(14);
                doc.text(docInfo.name, 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                docInfo.fields.forEach(field => {
                    const value = formData[`${field}_${docId}`] || '';
                    doc.text(`${getFieldLabel(field)}: ${value}`, 25, yPosition);
                    yPosition += 7;
                });
                yPosition += 5;
                
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
            }
        });
        
        return doc;
    }

    function getDocumentInfo(docId, formType) {
        const typeMap = {
            'departurePetugas': 'petugasKeberangkatan',
            'arrivalPetugas': 'petugasKedatangan',
            'departureNelayan': 'nelayanKeberangkatan',
            'arrivalNelayan': 'nelayanKedatangan'
        };
        
        const documents = DOCUMENT_FORMS[typeMap[formType]];
        return documents ? documents.find(doc => doc.id === docId) : null;
    }

    function setupFormHandler(formId, formType, folderType) {
        const form = document.getElementById(formId);
        const statusEl = document.getElementById(`status${formType}`);
        
        // Setup checkbox change handlers
        const checkboxes = form.querySelectorAll('input[name="selectedDocs"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                toggleDocumentSection(checkbox, formType);
            });
        });
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                validateForm(form);
                showMessage(statusEl, '<i class="fas fa-spinner fa-spin"></i> Processing documents...', 'info');

                const formData = new FormData(form);
                const selectedDocs = Array.from(formData.getAll('selectedDocs'));
                
                // Collect form data
                const docData = {
                    namaKapal: formData.get('namaKapal'),
                    nakhoda: formData.get('nakhoda'),
                    tanggal: formData.get('tanggal'),
                    waktu: formData.get('waktu'),
                    tujuan: formData.get('tujuan'),
                    asal: formData.get('asal')
                };
                
                // Add document-specific fields
                selectedDocs.forEach(docId => {
                    const docInfo = getDocumentInfo(docId, formType);
                    if (docInfo) {
                        docInfo.fields.forEach(field => {
                            docData[`${field}_${docId}`] = formData.get(`${field}_${docId}`);
                        });
                    }
                });

                const doc = generatePDF(docData, selectedDocs, formType);
                const pdfBlob = doc.output('blob');
                const fileName = `${titleMap[formType]}_${docData.namaKapal}_${docData.tanggal}.pdf`.replace(/[^a-zA-Z0-9_.-]/g, '_');
                const file = new File([pdfBlob], fileName, { type: 'application/pdf' });

                const downloadUrl = URL.createObjectURL(file);
                statusEl.innerHTML = `
                    <div class="success-message">
                        <i class="fas fa-check-circle"></i> Documents successfully created.
                        <a href="${downloadUrl}" download="${fileName}" style="margin-left: 10px; color: #2980b9; font-weight: bold;">Download Documents</a>
                    </div>
                `;

                // Setup upload button
                const uploadBtn = form.querySelector('.btn-upload-drive');
                uploadBtn.onclick = async () => {
                    try {
                        showMessage(statusEl, '<i class="fas fa-spinner fa-spin"></i> Uploading to Google Drive...', 'info');
                        await uploadToDrive(file, folderType);
                        showMessage(statusEl, '<i class="fas fa-check-circle"></i> Documents successfully uploaded to Google Drive!', 'success');
                    } catch (err) {
                        console.error('Upload error:', err);
                        showMessage(statusEl, `<i class="fas fa-exclamation-triangle"></i> Upload failed: ${err.message}`, 'error');
                    }
                };

            } catch (error) {
                console.error('Form processing error:', error);
                showMessage(statusEl, `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`, 'error');
            }
        });
    }

    function initializePages() {
        const mainContent = document.getElementById('mainContent');
        
        const titleMap = {
            'departurePetugas': 'DOKUMEN KEBERANGKATAN PETUGAS',
            'arrivalPetugas': 'DOKUMEN KEDATANGAN PETUGAS', 
            'departureNelayan': 'DOKUMEN KEBERANGKATAN NELAYAN',
            'arrivalNelayan': 'DOKUMEN KEDATANGAN NELAYAN'
        };
        
        mainContent.innerHTML = `
            <!-- Departure Petugas Page -->
            <div id="departurePetugas" class="content-page">
                <div class="form-type-indicator">
                    <h3>Formulir Keberangkatan Petugas</h3>
                </div>
                <div class="card">
                    <h2>Generate Dokumen Keberangkatan</h2>
                    <form id="formDeparturePetugas">
                        <div class="form-row">
                            <div class="form-control">
                                <label for="namaKapalDP">Nama Kapal Perikanan</label>
                                <input type="text" id="namaKapalDP" name="namaKapal" required>
                            </div>
                            <div class="form-control">
                                <label for="nakhodaDP">Nakhoda</label>
                                <input type="text" id="nakhodaDP" name="nakhoda" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="tanggalDP">Tanggal Bertolak</label>
                                <input type="date" id="tanggalDP" name="tanggal" required>
                            </div>
                            <div class="form-control">
                                <label for="waktuDP">Jam Bertolak</label>
                                <input type="time" id="waktuDP" name="waktu" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="tujuanDP">Tujuan</label>
                                <input type="text" id="tujuanDP" name="tujuan" required>
                            </div>
                        </div>
                        
                        ${generateDocumentForm(DOCUMENT_FORMS.petugasKeberangkatan, 'departurePetugas')}
                        ${generateDocumentFields(DOCUMENT_FORMS.petugasKeberangkatan, 'departurePetugas')}
                        
                        <div class="google-drive-status">Connecting to Google Drive...</div>
                        <button type="submit" class="btn-generate">Generate Documents</button>
                        <button type="button" class="btn-upload-drive" disabled>Upload to Google Drive</button>
                    </form>
                    <div id="statusdeparturePetugas" class="result-container"></div>
                </div>
            </div>

            <!-- Arrival Petugas Page -->
            <div id="arrivalPetugas" class="content-page">
                <div class="form-type-indicator">
                    <h3>Formulir Kedatangan Petugas</h3>
                </div>
                <div class="card">
                    <h2>Generate Dokumen Kedatangan</h2>
                    <form id="formArrivalPetugas">
                        <div class="form-row">
                            <div class="form-control">
                                <label for="namaKapalAP">Nama Kapal Perikanan</label>
                                <input type="text" id="namaKapalAP" name="namaKapal" required>
                            </div>
                            <div class="form-control">
                                <label for="nakhodaAP">Nakhoda</label>
                                <input type="text" id="nakhodaAP" name="nakhoda" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="tanggalAP">Tanggal Tiba</label>
                                <input type="date" id="tanggalAP" name="tanggal" required>
                            </div>
                            <div class="form-control">
                                <label for="waktuAP">Jam Tiba</label>
                                <input type="time" id="waktuAP" name="waktu" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="asalAP">Asal Keberangkatan</label>
                                <input type="text" id="asalAP" name="asal" required>
                            </div>
                        </div>
                        
                        ${generateDocumentForm(DOCUMENT_FORMS.petugasKedatangan, 'arrivalPetugas')}
                        ${generateDocumentFields(DOCUMENT_FORMS.petugasKedatangan, 'arrivalPetugas')}
                        
                        <div class="google-drive-status">Connecting to Google Drive...</div>
                        <button type="submit" class="btn-generate">Generate Documents</button>
                        <button type="button" class="btn-upload-drive" disabled>Upload to Google Drive</button>
                    </form>
                    <div id="statusarrivalPetugas" class="result-container"></div>
                </div>
            </div>

            <!-- Departure Nelayan Page -->
            <div id="departureNelayan" class="content-page">
                <div class="form-type-indicator">
                    <h3>Formulir Keberangkatan Nelayan</h3>
                </div>
                <div class="card">
                    <h2>Generate Dokumen Keberangkatan</h2>
                    <form id="formDepartureNelayan">
                        <div class="form-row">
                            <div class="form-control">
                                <label for="namaKapalDN">Nama Kapal Perikanan</label>
                                <input type="text" id="namaKapalDN" name="namaKapal" required>
                            </div>
                            <div class="form-control">
                                <label for="nakhodaDN">Nakhoda</label>
                                <input type="text" id="nakhodaDN" name="nakhoda" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="tanggalDN">Tanggal Bertolak</label>
                                <input type="date" id="tanggalDN" name="tanggal" required>
                            </div>
                            <div class="form-control">
                                <label for="waktuDN">Jam Bertolak</label>
                                <input type="time" id="waktuDN" name="waktu" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="tujuanDN">Tujuan</label>
                                <input type="text" id="tujuanDN" name="tujuan" required>
                            </div>
                        </div>
                        
                        ${generateDocumentForm(DOCUMENT_FORMS.nelayanKeberangkatan, 'departureNelayan')}
                        ${generateDocumentFields(DOCUMENT_FORMS.nelayanKeberangkatan, 'departureNelayan')}
                        
                        <div class="google-drive-status">Connecting to Google Drive...</div>
                        <button type="submit" class="btn-generate">Generate Documents</button>
                        <button type="button" class="btn-upload-drive" disabled>Upload to Google Drive</button>
                    </form>
                    <div id="statusdepartureNelayan" class="result-container"></div>
                </div>
            </div>

            <!-- Arrival Nelayan Page -->
            <div id="arrivalNelayan" class="content-page">
                <div class="form-type-indicator">
                    <h3>Formulir Kedatangan Nelayan</h3>
                </div>
                <div class="card">
                    <h2>Generate Dokumen Kedatangan</h2>
                    <form id="formArrivalNelayan">
                        <div class="form-row">
                            <div class="form-control">
                                <label for="namaKapalAN">Nama Kapal Perikanan</label>
                                <input type="text" id="namaKapalAN" name="namaKapal" required>
                            </div>
                            <div class="form-control">
                                <label for="nakhodaAN">Nakhoda</label>
                                <input type="text" id="nakhodaAN" name="nakhoda" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="tanggalAN">Tanggal Tiba</label>
                                <input type="date" id="tanggalAN" name="tanggal" required>
                            </div>
                            <div class="form-control">
                                <label for="waktuAN">Jam Tiba</label>
                                <input type="time" id="waktuAN" name="waktu" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="asalAN">Asal Keberangkatan</label>
                                <input type="text" id="asalAN" name="asal" required>
                            </div>
                        </div>
                        
                        ${generateDocumentForm(DOCUMENT_FORMS.nelayanKedatangan, 'arrivalNelayan')}
                        ${generateDocumentFields(DOCUMENT_FORMS.nelayanKedatangan, 'arrivalNelayan')}
                        
                        <div class="google-drive-status">Connecting to Google Drive...</div>
                        <button type="submit" class="btn-generate">Generate Documents</button>
                        <button type="button" class="btn-upload-drive" disabled>Upload to Google Drive</button>
                    </form>
                    <div id="statusarrivalNelayan" class="result-container"></div>
                </div>
            </div>
        `;

        // Setup form handlers
        setupFormHandler('formDeparturePetugas', 'departurePetugas', 'Petugas-Keberangkatan');
        setupFormHandler('formArrivalPetugas', 'arrivalPetugas', 'Petugas-Kedatangan');
        setupFormHandler('formDepartureNelayan', 'departureNelayan', 'Nelayan-Keberangkatan');
        setupFormHandler('formArrivalNelayan', 'arrivalNelayan', 'Nelayan-Kedatangan');

        // Update Google Drive status for all forms
        updateGoogleDriveStatus();
    }

    function showPage(pageId, element) {
        // Hide all pages
        document.querySelectorAll('.content-page').forEach(page => {
            page.style.display = 'none';
        });
        
        // Show selected page
        document.getElementById(pageId).style.display = 'block';
        
        // Update active sidebar item
        document.querySelectorAll('.sidebar a').forEach(a => {
            a.classList.remove('active');
        });
        element.classList.add('active');
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded, initializing Google APIs...');
        initializeGoogle();
    });
</script>
</body>
</html>
