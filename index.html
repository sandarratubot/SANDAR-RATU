<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SANDAR-RATU - Sistem Administrasi & Dokumen Kesyahbandaran</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<style>
/* CSS Anda yang sudah ada */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;justify-content:center;align-items:center;}
.login-container{background:#fff;padding:40px;border-radius:15px;width:100%;max-width:420px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.15);}
.logo{width:80px;height:80px;margin:0 auto 15px;}
.login-title{font-size:22px;font-weight:600;margin-bottom:10px;color:#2c3e50;}
.subtitle{font-size:14px;color:#7f8c8d;margin-bottom:25px;}
.form-control{width:100%;padding:12px;margin-bottom:15px;border:1px solid #ddd;border-radius:8px;}
.btn-login{width:100%;padding:12px;border:none;border-radius:8px;background:#3498db;color:#fff;font-weight:bold;cursor:pointer;}
.btn-login:hover{background:#2980b9;}
.footer{font-size:12px;color:#7f8c8d;margin-top:20px;}
.dashboard{display:none;flex-direction:column;height:100vh;width:100%;}
.header{background:#2c3e50;color:white;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;}
.header .logo-icon{background:#3498db;width:36px;height:36px;border-radius:8px;display:flex;justify-content:center;align-items:center;margin-right:10px;}
.main-container{display:flex;flex:1;}
.sidebar{width:240px;background:#3498db;color:white;padding-top:20px;}
.sidebar div{padding:8px 20px;font-weight:600;opacity:0.8;font-size:13px;}
.sidebar a{display:flex;align-items:center;padding:12px 20px;color:white;text-decoration:none;transition:0.3s;cursor:pointer;}
.sidebar a:hover{background:rgba(255,255,255,0.1);}
.sidebar a.active{background:rgba(0,0,0,0.25);font-weight:bold;}
.content{flex:1;padding:25px;overflow-y:auto;background:#f5f5f5;}
.content h2{margin-bottom:20px;color:#2c3e50;}
.card{background:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.form-row{display:flex;gap:15px;margin-bottom:15px;}
.form-row .form-control{flex:1;}
.btn-generate{width:100%;padding:12px;background:#2ecc71;border:none;color:white;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:10px;}
.btn-generate:hover{background:#27ae60;}
.btn-upload-drive{width:100%;padding:12px;background:#1a73e8;border:none;color:white;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:10px;}
.btn-upload-drive:hover{background:#1557b0;}
.btn-upload-drive:disabled{background:#ccc;cursor:not-allowed;}
.result-container{margin-top:15px;}
.preview-container{margin-top:8px;padding:15px;background:#fafafa;border:1px solid #ddd;border-radius:6px;display:flex;flex-direction:column;gap:10px;}
.preview-container .document-info{background:#fff;padding:10px;border-radius:5px;border-left:4px solid #3498db;}
.preview-container .document-info h4{color:#2c3e50;margin-bottom:5px;}
.preview-container .document-info p{color:#7f8c8d;font-size:12px;}
.preview-container embed,.preview-container img{width:100%;max-height:300px;border-radius:6px;object-fit:contain;border:1px solid #ddd;}
.preview-container a{align-self:flex-start;text-decoration:none;color:#2980b9;font-weight:bold;padding:5px 10px;background:#ecf0f1;border-radius:4px;}
.qr-section{background:#fff;padding:15px;border-radius:8px;text-align:center;border:2px solid #3498db;margin-bottom:15px;}
.qr-section h3{color:#2c3e50;margin-bottom:10px;}
.qr-info{background:#e8f6ff;padding:10px;border-radius:6px;margin-top:10px;border:1px solid #3498db;}
.qr-info p{margin:3px 0;font-size:12px;color:#2c3e50;}
.qr-info .qr-url{background:#fff;padding:8px;margin:5px 0;border-radius:4px;word-break:break-all;font-family:monospace;font-size:13px;border:1px solid #bdc3c7;max-height:60px;overflow-y:auto;}
.document-summary{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #27ae60;}
.document-summary h3{color:#2c3e50;margin-bottom:10px;}
.document-summary table{width:100%;border-collapse:collapse;}
.document-summary table td{padding:5px;border-bottom:1px solid #ecf0f1;}
.document-summary table td:first-child{font-weight:bold;width:30%;}
.form-type-indicator{background:#e8f4f8;border:2px solid #3498db;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;}
.form-type-indicator h3{color:#2c3e50;margin:0;}
.test-qr-btn{background:#e74c3c;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin:5px;font-size:12px;}
.test-qr-btn:hover{background:#c0392b;}
.content-page{display:none;}
.content-page.active{display:block;}
.document-label{display:block;margin-bottom:10px;font-weight:600;color:#2c3e50;}
.document-label input{margin-top:5px;}
.upload-status{background:#e8f5e8;border:1px solid #4caf50;color:#2e7d32;padding:10px;border-radius:6px;margin:10px 0;}
.upload-error{background:#ffebee;border:1px solid #f44336;color:#c62828;padding:10px;border-radius:6px;margin:10px 0;}
.google-drive-status{background:#e3f2fd;border:1px solid #2196f3;color:#1565c0;padding:10px;border-radius:6px;margin:10px 0;text-align:center;}
.progress-bar{width:100%;background:#f0f0f0;border-radius:4px;overflow:hidden;margin:10px 0;display:none;}
.progress-fill{height:20px;background:#4caf50;border-radius:4px;transition:width 0.3s ease;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:bold;}
</style>
</head>
<body>

<div id="loginPage" class="login-container">
<div class="logo"><img src="icon.jpeg" alt="Logo Anchor" style="width:80px; height:auto;"></div>
  <h2 class="login-title">SANDAR-RATU</h2>
  <p class="subtitle">üìã Sistem Administrasi & Dokumen<br>Kesyahbandaran PPN Palabuhanratu</p>
  <form id="loginForm">
    <input type="text" id="username" class="form-control" placeholder="Nama Pengguna / Email" required>
    <input type="password" id="password" class="form-control" placeholder="Kata Sandi" required>
    <button type="submit" class="btn-login">Masuk</button>
  </form>
  <div class="footer">Hak Cipta ¬© 2025 Sandar-Ratu</div>
</div>

<div id="dashboard" class="dashboard">
  <div class="header">
    <div style="display:flex;align-items:center;">
      <div class="logo-icon"><i class="fas fa-anchor"></i></div>
      <strong>SANDAR-RATU</strong>
    </div>
    <button onclick="logout()" style="background:#e74c3c;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;">Keluar</button>
  </div>
  <div class="main-container">
    <div class="sidebar">
      <div>üë®‚Äç‚úàÔ∏è Petugas</div>
      <a onclick="showPage('departurePetugas', this)"><i class="fas fa-anchor"></i>&nbsp; Keberangkatan</a>
      <a onclick="showPage('arrivalPetugas', this)"><i class="fas fa-ship"></i>&nbsp; Kedatangan</a>
      <div>üö¢ Nelayan</div>
      <a onclick="showPage('departureNelayan', this)"><i class="fas fa-fish"></i>&nbsp; Keberangkatan</a>
      <a onclick="showPage('arrivalNelayan', this)"><i class="fas fa-water"></i>&nbsp; Kedatangan</a>
    </div>

    <div class="content" id="mainContent">
      </div>
  </div>
</div>

<script>
// =========================================================
//            KONFIGURASI & VARIABEL GLOBAL
// =========================================================
const CLIENT_ID = "800620913330-i15l4t61k2ob1gk03rkoc4kt4aavfe1u.apps.googleusercontent.com";
const SCOPES = "https://www.googleapis.com/auth/drive.file";
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

const FOLDER_MAP = {
  "Petugas-Keberangkatan": "1Ws2ctYHbdUD7Wza2ld4KxO0j7fiFcg3o",
  "Petugas-Kedatangan": "1BIDQw9AMiY5_Mxt1OBKC1Lce3xzjtfTz",
  "Nelayan-Keberangkatan": "1bnyimhbu884iAdNX75u_MxtPN2azgAFy",
  "Nelayan-Kedatangan": "1Yt_-nTkJrZNO7Y2ZlBJIqebnMu0ncE-M"
};

let googleAuth;
let isGoogleDriveReady = false;

const menu = [
  {id:'departurePetugas', title:'‚öì Petugas - Keberangkatan', type: 'departure', category: 'Petugas'},
  {id:'arrivalPetugas', title:'‚öì Petugas - Kedatangan', type: 'arrival', category: 'Petugas'},
  {id:'departureNelayan', title:'üö¢ Nelayan - Keberangkatan', type: 'departure', category: 'Nelayan'},
  {id:'arrivalNelayan', title:'üö¢ Nelayan - Kedatangan', type: 'arrival', category: 'Nelayan'}
];

const departurePetugasDocuments = [
  'SPB', 'Crew List', 'Perbekalan', 'SLO', 'Pernyataan Nahkoda',
  'Kwitansi Tambat Labuh', 'Permohonan Penerbitan SPB', 'Daftar ABK', 'STBLKK', 'Faktur BBM'
];

const departureNelayanDocuments = [
  'SPB', 'Crew List', 'Perbekalan', 'SLO', 'Pernyataan Nahkoda'
];

const arrivalDocuments = [
  'STBLKK', 'Rekom Bongkar', 'SPB Asal'
];

// =========================================================
//          FUNGSI UTAMA & UTILITY
// =========================================================
function initializeGoogleDrive() {
  gapi.load('client:auth2', () => {
    gapi.client.init({
      clientId: CLIENT_ID,
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES
    }).then(() => {
      googleAuth = gapi.auth2.getAuthInstance();
      isGoogleDriveReady = true;
      googleAuth.isSignedIn.listen(updateGoogleDriveStatus);
      updateGoogleDriveStatus(googleAuth.isSignedIn.get());
      console.log('Google Drive API initialized successfully.');
    }).catch(error => {
      console.error('Error initializing Google Drive API:', error);
      updateGoogleDriveStatus(false, 'Error: ' + error.message);
    });
  });
}

function updateGoogleDriveStatus(isSignedIn, errorMsg = null) {
  const statusElements = document.querySelectorAll('.google-drive-status');
  statusElements.forEach(el => {
    if (errorMsg) {
      el.className = 'google-drive-status upload-error';
      el.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMsg}`;
    } else if (isSignedIn) {
      el.className = 'google-drive-status upload-status';
      el.innerHTML = '<i class="fas fa-check-circle"></i> Google Drive terhubung dan siap digunakan';
    } else {
      el.className = 'google-drive-status';
      if (isGoogleDriveReady) {
        el.style.background = '#fff3e0';
        el.style.borderColor = '#ff9800';
        el.style.color = '#f57c00';
        el.innerHTML = '<i class="fas fa-info-circle"></i> Klik "Upload" untuk login Google Drive';
      } else {
        el.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menghubungkan ke Google Drive...';
      }
    }
  });
  enableUploadButtons();
}

async function signInToGoogleDrive() {
  if (!isGoogleDriveReady) {
    alert('Google Drive API belum siap. Mohon tunggu.');
    return false;
  }
  if (!googleAuth.isSignedIn.get()) {
    try {
      await googleAuth.signIn();
      return true;
    } catch (error) {
      console.error('Sign in failed:', error);
      alert('Gagal login ke Google Drive: ' + error.message);
      return false;
    }
  }
  return true;
}

async function uploadFileToGoogleDrive(file, folderId, fileName) {
  const metadata = {
    name: fileName,
    parents: [folderId]
  };
  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  form.append('file', file);
  const accessToken = googleAuth.currentUser.get().getAuthResponse().access_token;
  const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
    method: 'POST',
    headers: new Headers({
      'Authorization': 'Bearer ' + accessToken
    }),
    body: form
  });
  if (!response.ok) {
    const errorBody = await response.json();
    throw new Error(`Upload failed with status ${response.status}: ${errorBody.error?.message || 'Unknown error'}`);
  }
  return await response.json();
}

function enableUploadButtons() {
  const uploadButtons = document.querySelectorAll('.btn-upload-drive');
  uploadButtons.forEach(btn => {
    btn.disabled = !isGoogleDriveReady;
  });
}

// =========================================================
//            FUNGSI UTAMA APLIKASI
// =========================================================
document.getElementById("loginForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  if (username && password) {
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboard").style.display = "flex";
    document.body.style.background = "white";
    initializePages();
    initializeGoogleDrive();
    showPage('departurePetugas', document.querySelector(".sidebar a"));
  } else {
    alert("Isi username & password!");
  }
});

function logout() {
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("loginPage").style.display = "block";
  document.body.style.background = "linear-gradient(135deg,#667eea,#764ba2)";
  document.getElementById("mainContent").innerHTML = "";
  if (googleAuth && googleAuth.isSignedIn.get()) {
    googleAuth.signOut();
  }
}

function showPage(pageId, el) {
  document.querySelectorAll(".content-page").forEach(p => p.style.display = "none");
  const targetPage = document.getElementById(pageId);
  if (targetPage) {
    targetPage.style.display = "block";
  }
  document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
  if (el) {
    el.classList.add("active");
  }
}

function initializePages() {
  const contentDiv = document.getElementById("mainContent");
  contentDiv.innerHTML = "";
  menu.forEach(m => {
    const div = document.createElement('div');
    div.id = m.id;
    div.className = 'content-page';
    let documents;
    if (m.type === 'arrival') {
      documents = arrivalDocuments;
    } else if (m.id === 'departurePetugas') {
      documents = departurePetugasDocuments;
    } else if (m.id === 'departureNelayan') {
      documents = departureNelayanDocuments;
    }
    const documentInputs = documents.map(doc => 
      `<label class="document-label">${doc}: <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required></label>`
    ).join('');
    div.innerHTML = `
      <h2>${m.title}</h2>
      <div class="card">
        <div class="form-type-indicator"><h3>üìã Form ${m.category} - ${m.type === 'departure' ? 'Keberangkatan' : 'Kedatangan'}</h3></div>
        <div class="google-drive-status"><i class="fas fa-spinner fa-spin"></i> Menghubungkan ke Google Drive...</div>
        <form data-form-type="${m.category}-${m.type === 'departure' ? 'Keberangkatan' : 'Kedatangan'}">
          <input type="text" class="form-control" placeholder="Nama Kapal" required>
          <div class="form-row">
            <input type="date" class="form-control" required>
            <input type="time" class="form-control" required>
          </div>
          <input type="text" class="form-control" placeholder="Kapten Kapal" required>
          <input type="text" class="form-control" placeholder="GT (Opsional)">
          <h4 style="margin:15px 0 10px;color:#2c3e50;">üìé Upload Dokumen</h4>
          ${documentInputs}
          <button type="button" class="btn-generate" onclick="generateAll(this)">Generate QR & Preview</button>
          <button type="button" class="btn-upload-drive" onclick="uploadToGoogleDrive(this)" disabled><i class="fab fa-google-drive"></i> Upload ke Google Drive</button>
          <button type="button" class="btn-generate" onclick="downloadAll(this)">‚¨á Download Semua Dokumen + QR PDF</button>
          <div class="progress-bar"><div class="progress-fill" style="width: 0%;">0%</div></div>
          <div class="upload-status" style="display:none;"></div>
          <div class="upload-error" style="display:none;"></div>
        </form>
        <div class="result-container"></div>
      </div>
    `;
    contentDiv.appendChild(div);
  });
  const today = new Date().toISOString().split("T")[0];
  const now = new Date().toTimeString().slice(0, 5);
  document.querySelectorAll('input[type="date"]').forEach(input => input.value = today);
  document.querySelectorAll('input[type="time"]').forEach(input => input.value = now);
}

async function uploadToGoogleDrive(btn) {
  const form = btn.closest("form");
  const formType = form.getAttribute('data-form-type');
  const progressBar = form.querySelector('.progress-bar');
  const progressFill = form.querySelector('.progress-fill');
  const statusDiv = form.querySelector('.upload-status');
  const errorDiv = form.querySelector('.upload-error');
  statusDiv.style.display = 'none';
  errorDiv.style.display = 'none';
  if (!await signInToGoogleDrive()) {
    return;
  }
  const shipName = form.querySelector('input[type="text"]').value.trim();
  const date = form.querySelector('input[type="date"]').value;
  const time = form.querySelector('input[type="time"]').value;
  const captain = form.querySelectorAll('input[type="text"]')[1].value.trim();
  if (!shipName) {
    errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Nama kapal harus diisi!';
    errorDiv.style.display = 'block';
    return;
  }
  const folderId = FOLDER_MAP[formType];
  if (!folderId) {
    errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Folder tidak ditemukan untuk jenis form ini!';
    errorDiv.style.display = 'block';
    return;
  }
  const fileInputs = Array.from(form.querySelectorAll('input[type="file"]'));
  const filesToUpload = fileInputs.filter(input => input.files[0]).map(input => ({
    file: input.files[0],
    label: input.parentElement.textContent.split(':')[0].trim()
  }));
  if (filesToUpload.length === 0) {
    errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Pilih minimal satu file untuk diunggah!';
    errorDiv.style.display = 'block';
    return;
  }
  btn.disabled = true;
  progressBar.style.display = 'block';
  statusDiv.style.display = 'block';
  statusDiv.innerHTML = `<i class="fas fa-upload"></i> Mengunggah 0 dari ${filesToUpload.length} file...`;
  try {
    let uploadedCount = 0;
    const totalFiles = filesToUpload.length;
    const results = [];
    for (const fileData of filesToUpload) {
      const { file, label } = fileData;
      const timestamp = date.replace(/-/g, '') + '_' + time.replace(':', '');
      const fileName = `[${formType}]_${shipName.replace(/\s+/g, '_')}_${label}_${timestamp}.${file.name.split('.').pop()}`;
      try {
        const result = await uploadFileToGoogleDrive(file, folderId, fileName);
        if (result.id) {
          uploadedCount++;
          results.push({ name: fileName, label: label, id: result.id, url: `https://drive.google.com/open?id=${result.id}` });
        } else {
          throw new Error('Upload failed.');
        }
      } catch (error) {
        console.error(`Error uploading ${fileName}:`, error);
        results.push({ name: fileName, label: label, error: error.message });
      }
      const progress = Math.round((uploadedCount / totalFiles) * 100);
      progressFill.style.width = progress + '%';
      progressFill.textContent = progress + '%';
      statusDiv.innerHTML = `<i class="fas fa-upload"></i> Mengunggah ${uploadedCount} dari ${totalFiles} file...`;
    }
    const successCount = results.filter(r => !r.error).length;
    const errorCount = results.filter(r => r.error).length;
    let resultHtml = '';
    if (successCount > 0) {
      resultHtml += `<i class="fas fa-check-circle"></i> Berhasil mengunggah ${successCount} file!<br>`;
      results.filter(r => !r.error).forEach(r => {
        resultHtml += `‚Ä¢ <strong>${r.label}</strong>: <a href="${r.url}" target="_blank">${r.name}</a><br>`;
      });
    }
    if (errorCount > 0) {
      resultHtml += `<br><strong style="color:#c62828;"><i class="fas fa-exclamation-triangle"></i> Gagal mengunggah ${errorCount} file:</strong><br>`;
      results.filter(r => r.error).forEach(r => {
        resultHtml += `‚Ä¢ <strong>${r.label}</strong>: ${r.error}<br>`;
      });
      statusDiv.className = 'upload-error';
      statusDiv.style.background = '#ffebee';
      statusDiv.style.borderColor = '#f44336';
      statusDiv.style.color = '#c62828';
    } else {
      statusDiv.className = 'upload-status';
      statusDiv.style.background = '#e8f5e8';
      statusDiv.style.borderColor = '#4caf50';
      statusDiv.style.color = '#2e7d32';
    }
    statusDiv.innerHTML = resultHtml;
  } catch (error) {
    console.error('Upload process failed:', error);
    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Terjadi kesalahan: ${error.message}`;
    errorDiv.style.display = 'block';
    statusDiv.style.display = 'none';
  } finally {
    btn.disabled = false;
    progressBar.style.display = 'none';
    progressFill.style.width = '0%';
    progressFill.textContent = '0%';
  }
}

function generateAll(btn) {
  const form = btn.closest("form");
  const resultBox = form.nextElementSibling;
  const formType = form.getAttribute('data-form-type');
  resultBox.innerHTML = "";
  const shipName = form.querySelector('input[type="text"]').value || "KAPAL";
  const date = form.querySelector('input[type="date"]').value || new Date().toISOString().split('T')[0];
  const time = form.querySelector('input[type="time"]').value || "00:00";
  const captain = form.querySelectorAll('input[type="text"]')[1].value || "KAPTEN";
  const gt = form.querySelectorAll('input[type="text"]')[2].value || "-";
  const formattedDate = date.replace(/-/g, '');
  const formattedTime = time.replace(':', '');
  const code = `SANDAR-${shipName.replace(/\s+/g, '')}-${formattedDate}-${formattedTime}`;
  const summaryDiv = document.createElement("div");
  summaryDiv.className = "document-summary";
  summaryDiv.innerHTML = `
    <h3>üìã Ringkasan Dokumen</h3>
    <table>
      <tr><td>Jenis Form:</td><td><strong>${formType}</strong></td></tr>
      <tr><td>Nama Kapal:</td><td>${shipName}</td></tr>
      <tr><td>Tanggal:</td><td>${new Date(date).toLocaleDateString('id-ID')}</td></tr>
      <tr><td>Waktu:</td><td>${time}</td></tr>
      <tr><td>Kapten:</td><td>${captain}</td></tr>
      <tr><td>GT:</td><td>${gt}</td></tr>
      <tr><td>Kode Dokumen:</td><td><strong>${code}</strong></td></tr>
      <tr><td>Dibuat:</td><td>${new Date().toLocaleString('id-ID')}</td></tr>
    </table>
  `;
  resultBox.appendChild(summaryDiv);
  const qrSection = document.createElement("div");
  qrSection.className = "qr-section";
  qrSection.innerHTML = `<h3>üî≤ QR Code Dokumen</h3>`;
  const qrDiv = document.createElement("div");
  qrDiv.id = `qrcode-${Date.now()}`;
  qrSection.appendChild(qrDiv);
  const folderId = FOLDER_MAP[formType];
  const baseUrl = `https://drive.google.com/drive/folders/1ZpBOs2z1OkHMWFW5Zy4D4_fd_3v62xOa`;
  const params = new URLSearchParams({
    code: code,
    type: formType,
    ship: shipName,
    date: date,
    time: time,
    captain: captain,
    gt: gt
  });
  const qrUrl = `${baseUrl}?${params.toString()}`;
  const qrInfo = document.createElement("div");
  qrInfo.className = "qr-info";
  qrInfo.innerHTML = `
    <p><strong>üîó URL QR Code:</strong></p>
    <div class="qr-url">${qrUrl}</div>
    <p><strong>üìè Panjang URL:</strong> ${qrUrl.length} karakter</p>
    <p><strong>üìä Error Correction:</strong> Medium (25%)</p>
    <p><strong>üìÅ Folder:</strong> ${formType}</p>
    <button class="test-qr-btn" onclick="copyToClipboard('${qrUrl.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">üìã Copy URL</button>
    <button class="test-qr-btn" onclick="openUrl('${qrUrl.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">üîó Test URL</button>
  `;
  qrSection.appendChild(qrInfo);
  resultBox.appendChild(qrSection);
  try {
    new QRCode(qrDiv, {
      text: qrUrl,
      width: 256,
      height: 256,
      colorDark: "#2c3e50",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.M
    });
  } catch (error) {
    console.error('Error generating QR code:', error);
    qrDiv.innerHTML = '<p style="color: red;">Error generating QR code</p>';
  }
  let docCount = 0;
  const fileInputs = form.querySelectorAll('input[type="file"]');
  fileInputs.forEach((fileInput, index) => {
    if (fileInput.files[0]) {
      docCount++;
      const file = fileInput.files[0];
      const label = fileInput.parentElement.textContent.split(':')[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewContainer = document.createElement("div");
        previewContainer.className = "preview-container";
        const docInfo = document.createElement("div");
        docInfo.className = "document-info";
        docInfo.innerHTML = `
          <h4>${label}</h4>
          <p>üìÑ ${file.name} | üìè ${(file.size/1024).toFixed(2)} KB | üìÖ ${new Date().toLocaleDateString('id-ID')}<br>
          <strong>üìã Jenis: ${formType}</strong></p>
        `;
        previewContainer.appendChild(docInfo);
        let previewEl;
        if (file.type.includes("pdf")) {
          previewEl = document.createElement("embed");
          previewEl.src = e.target.result;
          previewEl.type = "application/pdf";
        } else if (file.type.includes("image")) {
          previewEl = document.createElement("img");
          previewEl.src = e.target.result;
          previewEl.alt = file.name;
        } else {
          previewEl = document.createElement("div");
          previewEl.innerHTML = `<p style="text-align:center;padding:50px;color:#7f8c8d;">üìÑ ${file.name}<br><small>Preview tidak tersedia untuk tipe file ini</small></p>`;
        }
        previewContainer.appendChild(previewEl);
        const downloadLink = document.createElement("a");
        downloadLink.href = e.target.result;
        downloadLink.download = `[${formType}]_${code}_${label}_${file.name}`;
        downloadLink.textContent = `‚¨á Download ${label}`;
        previewContainer.appendChild(downloadLink);
        resultBox.appendChild(previewContainer);
      };
      reader.readAsDataURL(file);
    }
  });
  if (docCount === 0) {
    alert("Silakan unggah minimal satu dokumen!");
    return;
  }
  const uploadBtn = form.querySelector('.btn-upload-drive');
  if (uploadBtn && isGoogleDriveReady) {
    uploadBtn.disabled = false;
  }
}

function copyToClipboard(text) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert('URL berhasil disalin ke clipboard!');
    }).catch(err => {
      console.error('Gagal menyalin: ', err);
      fallbackCopyToClipboard(text);
    });
  } else {
    fallbackCopyToClipboard(text);
  }
}

function fallbackCopyToClipboard(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.position = "fixed";
  textArea.style.left = "-999999px";
  textArea.style.top = "-999999px";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
    document.execCommand('copy');
    alert('URL berhasil disalin ke clipboard!');
  } catch (err) {
    console.error('Fallback copy failed: ', err);
    alert('Gagal menyalin URL');
  }
  document.body.removeChild(textArea);
}

function openUrl(url) {
  window.open(url, '_blank');
}

async function downloadAll(btn) {
  const form = btn.closest("form");
  const resultBox = form.nextElementSibling;
  const formType = form.getAttribute('data-form-type');
  if (!resultBox.innerHTML.trim()) {
    alert("Generate QR & Preview terlebih dahulu!");
    return;
  }
  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    let yOffset = 20;
    const pageHeight = 297;
    const pageWidth = 210;
    const margin = 20;
    const shipName = form.querySelector('input[type="text"]').value || "KAPAL";
    const date = form.querySelector('input[type="date"]').value || new Date().toISOString().split('T')[0];
    const time = form.querySelector('input[type="time"]').value || "00:00";
    const captain = form.querySelectorAll('input[type="text"]')[1].value || "KAPTEN";
    const gt = form.querySelectorAll('input[type="text"]')[2].value || "-";
    function checkAndAddPage(neededHeight) {
      if (yOffset + neededHeight > pageHeight - 35) {
        pdf.addPage();
        yOffset = 20;
        return true;
      }
      return false;
    }
    pdf.setFontSize(18);
    pdf.setFont(undefined, 'bold');
    pdf.text('SANDAR-RATU', pageWidth/2, yOffset, { align: 'center' });
    yOffset += 8;
    pdf.setFontSize(12);
    pdf.text('Sistem Administrasi & Dokumen Kesyahbandaran', pageWidth/2, yOffset, { align: 'center' });
    yOffset += 5;
    pdf.text('PPN Palabuhanratu', pageWidth/2, yOffset, { align: 'center' });
    yOffset += 20;
    pdf.setDrawColor(52, 152, 219);
    pdf.setFillColor(232, 244, 248);
    pdf.roundedRect(margin, yOffset, pageWidth - 2*margin, 15, 3, 3, 'FD');
    yOffset += 10;
    pdf.setFontSize(14);
    pdf.setFont(undefined, 'bold');
    pdf.setTextColor(44, 62, 80);
    pdf.text('JENIS FORM: ' + formType, pageWidth/2, yOffset, { align: 'center' });
    yOffset += 15;
    pdf.setDrawColor(100);
    pdf.setFillColor(245, 245, 245);
    pdf.roundedRect(margin, yOffset, pageWidth - 2*margin, 40, 3, 3, 'FD');
    yOffset += 10;
    pdf.setFontSize(12);
    pdf.setFont(undefined, 'bold');
    pdf.setTextColor(0);
    pdf.text('INFORMASI DOKUMEN', margin + 10, yOffset);
    yOffset += 8;
    pdf.setFontSize(10);
    pdf.setFont(undefined, 'normal');
    pdf.text('Nama Kapal: ' + shipName, margin + 10, yOffset);
    pdf.text('GT: ' + gt, margin + 100, yOffset);
    yOffset += 6;
    pdf.text('Tanggal: ' + new Date(date).toLocaleDateString('id-ID'), margin + 10, yOffset);
    pdf.text('Waktu: ' + time, margin + 100, yOffset);
    yOffset += 6;
    pdf.text('Kapten: ' + captain, margin + 10, yOffset);
    yOffset += 20;
    const qrCanvas = resultBox.querySelector('canvas');
    if (qrCanvas) {
      checkAndAddPage(70);
      pdf.setFontSize(12);
      pdf.setFont(undefined, 'bold');
      pdf.text('QR Code Dokumen', pageWidth/2, yOffset, { align: 'center' });
      const qrImage = qrCanvas.toDataURL("image/png");
      yOffset += 5;
      const qrSize = 50;
      pdf.addImage(qrImage, 'PNG', pageWidth/2 - qrSize/2, yOffset, qrSize, qrSize);
      yOffset += qrSize + 5;
      pdf.setFontSize(8);
      pdf.setFont(undefined, 'normal');
      pdf.text(resultBox.querySelector('.qr-url').textContent, pageWidth/2, yOffset, { align: 'center' });
      yOffset += 10;
    }
    const fileInputs = form.querySelectorAll('input[type="file"]');
    for (const fileInput of fileInputs) {
      if (fileInput.files[0]) {
        const file = fileInput.files[0];
        const label = fileInput.parentElement.textContent.split(':')[0];
        const fileType = file.type;
        const reader = new FileReader();
        const fileDataPromise = new Promise(resolve => {
          reader.onload = e => resolve(e.target.result);
          reader.readAsDataURL(file);
        });
        const fileData = await fileDataPromise;
        checkAndAddPage(10);
        pdf.setFontSize(12);
        pdf.setFont(undefined, 'bold');
        pdf.text('Dokumen: ' + label, margin, yOffset);
        yOffset += 5;
        if (fileType.includes("pdf")) {
          checkAndAddPage(200);
          pdf.addFileToJSPDF(fileData, { 'page-size': 'A4' });
          pdf.addPage();
          yOffset = 20;
        } else if (fileType.includes("image")) {
          checkAndAddPage(150);
          const img = new Image();
          img.src = fileData;
          await new Promise(resolve => {
            img.onload = resolve;
          });
          const imgWidth = img.width;
          const imgHeight = img.height;
          const ratio = Math.min((pageWidth - 2 * margin) / imgWidth, (pageHeight - yOffset - margin) / imgHeight);
          const scaledWidth = imgWidth * ratio;
          const scaledHeight = imgHeight * ratio;
          pdf.addImage(img, 'JPEG', margin + (pageWidth - 2 * margin - scaledWidth) / 2, yOffset, scaledWidth, scaledHeight);
          yOffset += scaledHeight + 10;
        } else {
          checkAndAddPage(20);
          pdf.setFontSize(10);
          pdf.text('Preview tidak tersedia untuk tipe file ini.', margin, yOffset);
          yOffset += 10;
        }
      }
    }
    const finalFileName = `[${formType}]_${shipName.replace(/\s+/g, '_')}_${date.replace(/-/g,'')}.pdf`;
    pdf.save(finalFileName);
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('Gagal mengunduh PDF: ' + error.message);
  }
}

window.onload = function() {
    updateGoogleDriveStatus(false);
};
</script>
</body>
</html>
