<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SANDAR-RATU - Sistem Administrasi & Dokumen Kesyahbandaran</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#f8f9fa;min-height:100vh;display:flex;justify-content:center;align-items:center;}

.login-container{background:#fff;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);max-width:400px;width:100%;overflow:hidden;}
.logo-section{text-align:center;padding:40px 30px 20px;background:linear-gradient(135deg,#3498db, #1a73e8);}
.logo{display:inline-flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;font-size:24px;font-weight:700;color:#fff;text-decoration:none;}
.logo-icon{width:80px;height:80px;background:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);}
.logo-icon img{width:100%;height:100%;object-fit:contain;}
.warning-section{background:#feffd6;border:1px solid #fff4ce;margin:20px;border-radius:12px;padding:20px;text-align:center;}
.warning-title{background:#ffffff;border:1px solid #ffeaa7;color:#000000;padding:8px 16px;border-radius:8px;font-weight:600;margin-bottom:15px;display:inline-block;}
.warning-text{color:#000000;font-size:14px;line-height:1.5;margin-bottom:15px;}
.login-method-section{padding:20px;text-align:center;}
.method-title{color:#6c757d;font-size:13px;margin-bottom:15px;font-style:italic;}
.google-login-btn{width:100%;padding:12px 20px;border:2px solid #e0e0e0;background:#fff;border-radius:8px;display:flex;align-items:center;justify-content:center;gap:10px;font-size:14px;font-weight:500;color:#5f6368;cursor:pointer;transition:all 0.2s ease;}
.google-login-btn:hover{border-color:#1a73e8;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
.google-login-btn:disabled{background:#f5f5f5;cursor:not-allowed;opacity:0.6;}
.google-icon{width:18px;height:18px;}

.dashboard{display:none;flex-direction:column;height:100vh;width:100%;}
.header{background:#2c3e50;color:white;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;}
.header .logo-icon{background:#fff;width:42px;height:42px;border-radius:8px;display:flex;justify-content:center;align-items:center;margin-right:10px;padding:4px;}
.header .logo-icon img{width:100%;height:100%;object-fit:contain;}
.header .user-info{display:flex;align-items:center;gap:10px;}
.header .user-avatar{width:32px;height:32px;border-radius:50%;border:2px solid #3498db;}
.main-container{display:flex;flex:1;}
.sidebar{width:240px;background:#3498db;color:white;padding-top:20px;}
.sidebar div{padding:8px 20px;font-weight:600;opacity:0.8;font-size:13px;}
.sidebar a{display:flex;align-items:center;padding:12px 20px;color:white;text-decoration:none;transition:0.3s;cursor:pointer;}
.sidebar a:hover{background:rgba(255,255,255,0.1);}
.sidebar a.active{background:rgba(0,0,0,0.25);font-weight:bold;}
.content{flex:1;padding:25px;overflow-y:auto;background:#f5f5f5;}
.content h2{margin-bottom:20px;color:#2c3e50;}
.card{background:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.form-row{display:flex;gap:15px;margin-bottom:15px;}
.form-row .form-control{flex:1;}
.form-control{width:100%;padding:12px;margin-bottom:15px;border:1px solid #ddd;border-radius:8px;}
.btn-generate{width:100%;padding:12px;background:#2ecc71;border:none;color:white;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:10px;}
.btn-generate:hover{background:#27ae60;}
.btn-generate:disabled{background:#95a5a6;cursor:not-allowed;}
.btn-upload-drive{width:100%;padding:12px;background:#1a73e8;border:none;color:white;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:10px;}
.btn-upload-drive:hover:not(:disabled){background:#1557b0;}
.btn-upload-drive:disabled{background:#ccc;cursor:not-allowed;}
.btn-logout{background:#e74c3c;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;}
.result-container{margin-top:15px;}
.preview-container{margin-top:8px;padding:15px;background:#fafafa;border:1px solid #ddd;border-radius:6px;display:flex;flex-direction:column;gap:10px;}
.preview-container .document-info{background:#fff;padding:10px;border-radius:5px;border-left:4px solid #3498db;}
.preview-container .document-info h4{color:#2c3e50;margin-bottom:5px;}
.preview-container .document-info p{color:#7f8c8d;font-size:12px;}
.preview-container embed,.preview-container img{width:100%;max-height:300px;border-radius:6px;object-fit:contain;border:1px solid #ddd;}
.preview-container a{align-self:flex-start;text-decoration:none;color:#2980b9;font-weight:bold;padding:5px 10px;background:#ecf0f1;border-radius:4px;}
.qr-section{background:#fff;padding:15px;border-radius:8px;text-align:center;border:2px solid #3498db;margin-bottom:15px;}
.qr-section h3{color:#2c3e50;margin-bottom:10px;}
.qr-info{background:#e8f6ff;padding:10px;border-radius:6px;margin-top:10px;border:1px solid #3498db;}
.qr-info p{margin:3px 0;font-size:12px;color:#2c3e50;}
.qr-info .qr-url{background:#fff;padding:8px;margin:5px 0;border-radius:4px;word-break:break-all;font-family:monospace;font-size:13px;border:1px solid #bdc3c7;max-height:60px;overflow-y:auto;}
.document-summary{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #27ae60;}
.document-summary h3{color:#2c3e50;margin-bottom:10px;}
.document-summary table{width:100%;border-collapse:collapse;}
.document-summary table td{padding:5px;border-bottom:1px solid #ecf0f1;}
.document-summary table td:first-child{font-weight:bold;width:30%;}
.form-type-indicator{background:#e8f4f8;border:2px solid #3498db;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;}
.form-type-indicator h3{color:#2c3e50;margin:0;}
.test-qr-btn{background:#e74c3c;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin:5px;font-size:12px;}
.test-qr-btn:hover{background:#c0392b;}
.test-qr-btn.success{background:#27ae60;}
.test-qr-btn.success:hover{background:#229954;}
.content-page{display:none;}
.content-page.active{display:block;}
.document-label{display:block;margin-bottom:10px;font-weight:600;color:#2c3e50;}
.document-label input{margin-top:5px;}
.upload-status{background:#e8f5e8;border:1px solid #4caf50;color:#2e7d32;padding:10px;border-radius:6px;margin:10px 0;display:none;}
.upload-error{background:#ffebee;border:1px solid #f44336;color:#c62828;padding:10px;border-radius:6px;margin:10px 0;display:none;}
.google-drive-status{background:#e3f2fd;border:1px solid #2196f3;color:#1565c0;padding:10px;border-radius:6px;margin:10px 0;text-align:center;}
.progress-bar{width:100%;background:#f0f0f0;border-radius:4px;overflow:hidden;margin:10px 0;display:none;}
.progress-fill{height:20px;background:#4caf50;border-radius:4px;transition:width 0.3s ease;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:bold;}
.footer-login{text-align:center;padding:15px;color:#6c757d;font-size:12px;border-top:1px solid #e9ecef;}
.debug-info{background:#fff3cd;border:1px solid #ffc107;padding:10px;border-radius:6px;margin:10px 0;font-size:11px;font-family:monospace;}
.merge-info{background:#e8f5e9;border:2px solid #4caf50;padding:15px;border-radius:8px;margin:15px 0;text-align:center;}
.merge-info h4{color:#2e7d32;margin-bottom:10px;}
.merge-info p{color:#1b5e20;font-size:14px;line-height:1.6;}
</style>
</head>
<body>

<div id="loginPage" class="login-container">
  <div class="logo-section">
    <a href="#" class="logo">
      <div class="logo-icon">
        <img id="logoImg" src="logoicon.png" alt="SANDAR-RATU Logo">
      </div>
      SANDAR-RATU
    </a>
  </div>
  
  <div class="warning-section">
    <div class="warning-title">Peringatan</div>
    <div class="warning-text">
      Halaman ini memerlukan autentikasi.<br>
      Silahkan klik tombol login di bawah untuk melanjutkan.<br>
      Terima kasih.
    </div>
  </div>
  
  <div class="login-method-section">
    <div class="method-title">- pilih metode login -</div>
    <button id="googleLoginBtn" class="google-login-btn">
      <svg class="google-icon" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Log in with Google
    </button>
    <div id="loginDebug" class="debug-info" style="display:none;"></div>
  </div>
  
  <div class="footer-login">Hak Cipta Â© 2025 Sandar-Ratu</div>
</div>

<div id="dashboard" class="dashboard">
  <div class="header">
    <div style="display:flex;align-items:center;">
      <div class="logo-icon">
        <img id="headerLogoImg" src="logoicon.png" alt="Logo">
      </div>
      <strong>SANDAR-RATU</strong>
    </div>
    <div style="display:flex;align-items:center;gap:15px;">
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="" alt="User">
        <span id="userName">User</span>
      </div>
      <button class="btn-logout" onclick="logout()">Keluar</button>
    </div>
  </div>
  <div class="main-container">
    <div class="sidebar">
      <div>ð¨ââï¸ Petugas</div>
      <a onclick="showPage('departurePetugas', this)"><i class="fas fa-anchor"></i>&nbsp; Keberangkatan</a>
      <a onclick="showPage('arrivalPetugas', this)"><i class="fas fa-ship"></i>&nbsp; Kedatangan</a>
      <div>ð¢ Nelayan</div>
      <a onclick="showPage('departureNelayan', this)"><i class="fas fa-fish"></i>&nbsp; Keberangkatan</a>
      <a onclick="showPage('arrivalNelayan', this)"><i class="fas fa-water"></i>&nbsp; Kedatangan</a>
    </div>
    <div class="content" id="mainContent"></div>
  </div>
</div>

<script>
const CLIENT_ID = "464575855879-theqehj563fo25tp00gf6fhj6efr5045.apps.googleusercontent.com";
const API_KEY = "AIzaSyCYc9V2aXzmfOj8zcGbPdTimauSYxnCQd4";
const SCOPES = "https://www.googleapis.com/auth/drive.file";

const FOLDER_MAP = {
    "Petugas-Keberangkatan": "1OtloxktgdBBSFLwh1CUqYsYk25l2fsBH",
    "Petugas-Kedatangan": "1Z6fEANltfHjUsRnluXs6j6RE31rCczIk",
    "Nelayan-Keberangkatan": "1jBtsh2mj2oF2oyiJMu_subw_qo-C1FRv",
    "Nelayan-Kedatangan": "1AYPXMwl47Uj0p8SfxlVz7VmMVUP4l521"
};

let customLogo = null;
let isGAPIReady = false;
let currentUser = null;
let currentAccessToken = null;
let tokenClient = null;

function logDebug(msg) {
    console.log('[DEBUG]', msg);
    const debugEl = document.getElementById('loginDebug');
    if (debugEl) {
        debugEl.style.display = 'block';
        debugEl.innerHTML += msg + '<br>';
    }
}

function loadCustomLogo() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        customLogo = canvas.toDataURL('image/jpeg');
        
        document.getElementById('logoImg').src = customLogo;
        document.getElementById('headerLogoImg').src = customLogo;
    };
    
    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8IS0tIEJhY2tncm91bmQgLS0+CiAgPHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNmZmZmZmYiLz4KICAKICA8IS0tIEFuY2hvciAtLT4KICA8cGF0aCBkPSJNIDEwMCAyMCBMIDEwMCAxNDAgTSA1MCAxNDAgTCA1MCAxNjAgUSA1MCAxODAgNzAgMTgwIEwgMTMwIDE4MCBRIDE1MCAxODAgMTUwIDE2MCBMIDE1MCAxNDAgTSA1MCAxNDAgUSA1MCAxMjAgNzAgMTIwIEwgMTMwIDEyMCBRIDE1MCAxMjAgMTUwIDE0MCIgZmlsbD0iI0ZGRDcwMCIgc3Ryb2tlPSIjRkZBNTAwIiBzdHJva2Utd2lkdGg9IjMiLz4KICAKICA8IS0tIEZpc2ggLS0+CiAgPGVsbGlwc2UgY3g9IjEwMCIgY3k9IjkwIiByeD0iMzAiIHJ5PSI0MCIgZmlsbD0iIzIxOTZGMyIvPgogIDxwYXRoIGQ9Ik0gMTMwIDkwIEwgMTUwIDcwIEwgMTUwIDExMCBaIiBmaWxsPSIjMjE5NkYzIi8+CiAgPGNpcmNsZSBjeD0iOTAiIGN5PSI4MCIgcj0iMyIgZmlsbD0iIzAwMDAwMCIvPgogIAogIDwhLS0gTmV0IC0tPgogIDxsaW5lIHgxPSI0MCIgeTE9IjQwIiB4Mj0iNDAiIHkyPSIxNDAiIHN0cm9rZT0iIzRDQUY1MCIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPGxpbmUgeDE9IjE2MCIgeTE9IjQwIiB4Mj0iMTYwIiB5Mj0iMTQwIiBzdHJva2U9IiM0Q0FGNTA' +
        'IHN0cm9rZS13aWR0aD0iMiIvPgogIDxyZWN0IHg9IjQwIiB5PSI0MCIgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzRDQUY1MCIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPCEtLSBHcmlkIC0tPgogIDxwYXRoIGQ9Ik0gNTUgNDAgTCA1NSAxNDAgTSA3MCA0MCBMIDCMIDE0MCBNIDY1IDQwIEwgODUgMTQwIE0gMTAwIDQwIEwgMTAwIDE0MCBNIDEXNSA0MCBMIDEXNSA0MCBNIDEZWIDA0MCBMIDEZWIDA0MCBNIDE0NSA0MCBMIDE0NSAxNDAiIHN0cm9rZT0iIzRDQUY1MCIgc3Ryb2tlLXdpZHRoPSIxIi8+CiAgPHBhdGggZD0iTSA0MCA1NSBMIDE2MCA1NSBNICE3MCBMIDE2MCA3MCBNIDQWIDA4NSBMIDde2AgaNSBNIDQwIDEwMCBMIDE2MCAxMDAgTSA0MCAxMTUgTCAxNjAgMTE1IE0gNDAgMTMwIEwgMTYwIDEzMCIgc3Ryb2tlPSIjNENBRjUwIiBzdHJva2Utd2lkdGg9IjEiLz4KPC9zdmc+';
}

function initializeGoogle() {
    logDebug('Initializing Google APIs...');
    
    try {
        google.accounts.id.initialize({
            client_id: CLIENT_ID,
            callback: handleCredentialResponse,
            auto_select: false,
            cancel_on_tap_outside: true
        });
        logDebug('â Google Identity Services initialized');
    } catch (error) {
        logDebug('â Failed to init Google Identity: ' + error.message);
        return;
    }

    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (response) => {
                if (response.error !== undefined) {
                    logDebug('â Token error: ' + response.error);
                    updateGoogleDriveStatus('Gagal mendapatkan akses Drive');
                    return;
                }
                currentAccessToken = response.access_token;
                logDebug('â Access token obtained successfully');
                updateGoogleDriveStatus();
            }
        });

        isGAPIReady = true;
        logDebug('â Token Client initialized (Drive API ready)');
        updateGoogleDriveStatus();
    } catch (error) {
        logDebug('â Token Client error: ' + error.message);
        updateGoogleDriveStatus('Error: Gagal inisialisasi Drive API');
        isGAPIReady = false;
    }
}

function handleCredentialResponse(response) {
    if (!response.credential) {
        logDebug('â No credential received');
        return;
    }

    try {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        currentUser = {
            id: payload.sub,
            name: payload.name || 'User',
            email: payload.email || 'no-email',
            picture: payload.picture || ''
        };
        logDebug('â Login successful: ' + currentUser.name);
        showDashboard();
    } catch (error) {
        logDebug('â Parse error: ' + error.message);
        alert('Login failed. Please try again.');
    }
}

document.getElementById('googleLoginBtn').addEventListener('click', () => {
    try {
        logDebug('Attempting login...');
        google.accounts.id.prompt();
    } catch (error) {
        logDebug('â Login error: ' + error.message);
        alert('Google login is not available. Please check your connection.');
    }
});

function showDashboard() {
    if (!currentUser) return;
    
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("dashboard").style.display = "flex";
    document.body.style.background = "white";
    
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userAvatar').src = currentUser.picture || '';
    
    initializePages();
    showPage('departurePetugas', document.querySelector(".sidebar a"));
}

function updateGoogleDriveStatus(errorMsg = null) {
    const statusElements = document.querySelectorAll('.google-drive-status');
    
    statusElements.forEach(el => {
        if (errorMsg) {
            el.className = 'upload-error';
            el.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMsg}`;
            disableUploadButtons();
        } else if (isGAPIReady) {
            if (currentAccessToken) {
                el.className = 'upload-status';
                el.innerHTML = '<i class="fas fa-check-circle"></i> Google Drive terhubung dan siap';
                enableUploadButtons();
            } else {
                el.className = 'google-drive-status';
                el.innerHTML = '<i class="fas fa-info-circle"></i> Klik "Upload ke Google Drive" untuk koneksi';
                enableUploadButtons();
            }
        } else {
            el.className = 'google-drive-status';
            el.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menghubungkan ke Google Drive...';
            disableUploadButtons();
        }
    });
}

function enableUploadButtons() {
    document.querySelectorAll('.btn-upload-drive').forEach(btn => btn.disabled = false);
}

function disableUploadButtons() {
    document.querySelectorAll('.btn-upload-drive').forEach(btn => btn.disabled = true);
}

async function requestDrivePermission() {
    if (!tokenClient) throw new Error('Google API not initialized');

    return new Promise((resolve, reject) => {
        const originalCallback = tokenClient.callback;
        tokenClient.callback = (response) => {
            tokenClient.callback = originalCallback;
            if (response.error !== undefined) {
                reject(new Error(response.error));
            } else {
                currentAccessToken = response.access_token;
                updateGoogleDriveStatus();
                resolve(response.access_token);
            }
        };
        tokenClient.requestAccessToken();
    });
}

async function uploadToDrive(file, folderName) {
    if (!currentAccessToken) {
        await requestDrivePermission();
    }

    const folderId = FOLDER_MAP[folderName];
    if (!folderId) throw new Error(`Folder '${folderName}' not found`);

    const metadata = {
        name: file.name,
        parents: [folderId]
    };

    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
    form.append('file', file);

    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({'Authorization': `Bearer ${currentAccessToken}`}),
        body: form
    });

    if (!response.ok) {
        const error = await response.json();
        throw new Error(`Upload failed: ${response.status} - ${error.error?.message || 'Unknown error'}`);
    }

    return await response.json();
}

async function convertImageToPDF(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const img = new Image();
                img.onload = async function() {
                    const pdfDoc = await PDFLib.PDFDocument.create();
                    
                    let imgEmbed;
                    if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
                        imgEmbed = await pdfDoc.embedJpg(e.target.result);
                    } else if (file.type === 'image/png') {
                        imgEmbed = await pdfDoc.embedPng(e.target.result);
                    } else {
                        reject(new Error('Format gambar tidak didukung'));
                        return;
                    }
                    
                    const page = pdfDoc.addPage([imgEmbed.width, imgEmbed.height]);
                    page.drawImage(imgEmbed, {
                        x: 0,
                        y: 0,
                        width: imgEmbed.width,
                        height: imgEmbed.height,
                    });
                    
                    const pdfBytes = await pdfDoc.save();
                    resolve(pdfBytes);
                };
                img.onerror = () => reject(new Error('Gagal memuat gambar'));
                img.src = e.target.result;
            } catch (error) {
                reject(error);
            }
        };
        reader.onerror = () => reject(new Error('Gagal membaca file'));
        reader.readAsDataURL(file);
    });
}

async function mergePDFs(pdfFiles) {
    const mergedPdf = await PDFLib.PDFDocument.create();
    
    for (const pdfData of pdfFiles) {
        let pdfDoc;
        if (pdfData.bytes) {
            pdfDoc = await PDFLib.PDFDocument.load(pdfData.bytes);
        } else {
            pdfDoc = await PDFLib.PDFDocument.load(await pdfData.arrayBuffer());
        }
        
        const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
        copiedPages.forEach((page) => {
            mergedPdf.addPage(page);
        });
    }
    
    const mergedPdfBytes = await mergedPdf.save();
    return mergedPdfBytes;
}

async function generateQRCodeImage(url) {
    return new Promise((resolve, reject) => {
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        document.body.appendChild(tempDiv);
        
        try {
            new QRCode(tempDiv, {
                text: url,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            setTimeout(() => {
                const canvas = tempDiv.querySelector('canvas');
                if (canvas) {
                    canvas.toBlob((blob) => {
                        document.body.removeChild(tempDiv);
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('Failed to create blob from canvas'));
                        }
                    }, 'image/png');
                } else {
                    document.body.removeChild(tempDiv);
                    reject(new Error('QR canvas not found'));
                }
            }, 100);
        } catch (error) {
            document.body.removeChild(tempDiv);
            reject(error);
        }
    });
}

async function createCoverPage(formData, qrCodeUrl) {
  const pdfDoc = await PDFLib.PDFDocument.create();
  const page = pdfDoc.addPage([595, 842]); // A4
  const { width, height } = page.getSize();

  const helveticaBold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
  const helvetica = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

  let y = height - 90;

  // === HEADER ===
  page.drawText("SANDAR-RATU", {
    x: width / 2 - 100,
    y,
    size: 26,
    font: helveticaBold,
    color: PDFLib.rgb(0.3, 0.3, 0.3),
  });

  y -= 22;
  page.drawText("Sistem Administrasi & Dokumen Kesyahbandaran", {
    x: width / 2 - 125,
    y,
    size: 11,
    font: helvetica,
    color: PDFLib.rgb(0.3, 0.3, 0.3),
  });

  y -= 15;
  page.drawText("PPN Palabuhanratu", {
    x: width / 2 - 55,
    y,
    size: 11,
    font: helvetica,
    color: PDFLib.rgb(0.3, 0.3, 0.3),
  });

  // === FORM TYPE BOX ===
  y -= 60;
  const formBoxHeight = 40;
  const formBoxWidth = width - 140;
  const formBoxX = (width - formBoxWidth) / 2;

  page.drawRectangle({
    x: formBoxX,
    y: y - formBoxHeight,
    width: formBoxWidth,
    height: formBoxHeight,
    borderColor: PDFLib.rgb(0.3, 0.5, 0.8),
    borderWidth: 2,
    color: PDFLib.rgb(0.93, 0.97, 1),
  });

  page.drawText(`JENIS FORM: ${formData.formType}`, {
    x: width / 2 - 80,
    y: y - 13,
    size: 12,
    font: helveticaBold,
    color: PDFLib.rgb(0.2, 0.4, 0.6),
  });

  // === INFORMASI DOKUMEN BOX ===
  y -= 100;
  const infoBoxWidth = width - 140;
  const infoBoxHeight = 130;
  const infoBoxX = (width - infoBoxWidth) / 2;

  page.drawRectangle({
    x: infoBoxX,
    y: y - infoBoxHeight,
    width: infoBoxWidth,
    height: infoBoxHeight,
    borderColor: PDFLib.rgb(0.7, 0.7, 0.7),
    borderWidth: 1.5,
  });

  page.drawText("INFORMASI DOKUMEN", {
    x: infoBoxX + 15,
    y: y - 20,
    size: 11,
    font: helveticaBold,
    color: PDFLib.rgb(0.2, 0.2, 0.2),
  });

  const infoData = [
    [`Nama Kapal: ${formData.shipName}`, `GT: ${formData.gt}`],
    [`Tanggal: ${formData.date}`, `Waktu: ${formData.time}`],
    [`Nahkoda: ${formData.captain}`], 
    [`Petugas: ${formData.officer}` , ""],
  ];

  let infoY = y - 45;
  infoData.forEach(([left, right]) => {
    page.drawText(left, {
      x: infoBoxX + 20,
      y: infoY,
      size: 10,
      font: helvetica,
      color: PDFLib.rgb(0.2, 0.2, 0.2),
    });
    if (right) {
      page.drawText(right, {
        x: width / 2 + 60,
        y: infoY,
        size: 10,
        font: helvetica,
        color: PDFLib.rgb(0.2, 0.2, 0.2),
      });
    }
    infoY -= 22;
  });

  // === QR CODE ===
  y -= 190;
  page.drawText("QR CODE VERIFIKASI DOKUMEN", {
    x: width / 2 - 100,
    y,
    size: 11,
    font: helveticaBold,
    color: PDFLib.rgb(0.2, 0.2, 0.2),
  });

  const qrY = y - 130;
  const qrSize = 120;

  try {
    if (qrCodeUrl) {
      const qrBlob = await generateQRCodeImage(qrCodeUrl);
      const qrImageBytes = await qrBlob.arrayBuffer();
      const qrImage = await pdfDoc.embedPng(qrImageBytes);

      page.drawImage(qrImage, {
        x: width / 2 - qrSize / 2,
        y: qrY,
        width: qrSize,
        height: qrSize,
      });
    }
  } catch (error) {
    console.error("Error embedding QR code:", error);
    page.drawRectangle({
      x: width / 2 - 60,
      y: qrY,
      width: 120,
      height: 120,
      borderColor: PDFLib.rgb(0.6, 0.6, 0.6),
      borderWidth: 1,
    });
    page.drawText("[QR CODE]", {
      x: width / 2 - 30,
      y: qrY + 55,
      size: 10,
      font: helvetica,
      color: PDFLib.rgb(0.5, 0.5, 0.5),
    });
  }

  // === FOOTER ===
  page.drawText("DOKUMEN TERLAMPIR:", {
    x: 80,
    y: qrY - 40,
    size: 10,
    font: helveticaBold,
    color: PDFLib.rgb(0.2, 0.2, 0.2),
  });

  const pdfBytes = await pdfDoc.save();
  return pdfBytes;
}

async function uploadToGoogleDrive(btn) {
    const form = btn.closest("form");
    const formType = form.getAttribute('data-form-type');
    const progressBar = form.querySelector('.progress-bar');
    const progressFill = form.querySelector('.progress-fill');
    const statusDiv = form.querySelector('.upload-status');
    const errorDiv = form.querySelector('.upload-error');
    
    statusDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    
    const inputs = form.querySelectorAll('input[type="text"]');
    const shipName = inputs[0]?.value || "KAPAL";
    const captain = inputs[1]?.value || "Nahkoda";
    const gt = inputs[2]?.value || "-";
    
    const date = form.querySelector('input[type="date"]').value;
    const time = form.querySelector('input[type="time"]').value;
    const officerSelect = form.querySelector('select');
    const officer = officerSelect?.value || "Petugas tidak dipilih";
    
    if (!shipName.trim()) {
        errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Nama kapal harus diisi!';
        errorDiv.style.display = 'block';
        return;
    }
    
    const folderId = FOLDER_MAP[formType];
    if (!folderId) {
        errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Folder tidak ditemukan!';
        errorDiv.style.display = 'block';
        return;
    }
    
    const fileInputs = Array.from(form.querySelectorAll('input[type="file"]'));
    const filesToProcess = fileInputs.filter(input => input.files[0]).map(input => ({
        file: input.files[0],
        label: input.parentElement.textContent.split(':')[0]
    }));
    
    if (filesToProcess.length === 0) {
        errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Pilih minimal satu file!';
        errorDiv.style.display = 'block';
        return;
    }
    
    progressBar.style.display = 'block';
    btn.disabled = true;
    
    try {
        statusDiv.innerHTML = '<i class="fas fa-cog fa-spin"></i> Mengupload dokumen ke Google Drive...';
        statusDiv.style.display = 'block';
        progressFill.style.width = '10%';
        progressFill.textContent = '10%';
        
        statusDiv.innerHTML = '<i class="fas fa-upload"></i> Membuat dokumen sementara...';
        progressFill.style.width = '15%';
        progressFill.textContent = '15%';
        
        const tempPdfDoc = await PDFLib.PDFDocument.create();
        const tempPage = tempPdfDoc.addPage([595, 842]);
        tempPage.drawText('Processing...', { x: 50, y: 400, size: 20 });
        const tempPdfBytes = await tempPdfDoc.save();
        
        const timestamp = date.replace(/-/g, '') + '_' + time.replace(':', '');
        const tempFileName = `[${formType}]_${shipName.replace(/\s+/g, '_')}_TEMP_${timestamp}.pdf`;
        const tempBlob = new Blob([tempPdfBytes], { type: 'application/pdf' });
        const tempFile = new File([tempBlob], tempFileName, { type: 'application/pdf' });
        
        const tempResult = await uploadToDrive(tempFile, formType);
        const finalFileUrl = `https://drive.google.com/file/d/${tempResult.id}/view`;
        
        statusDiv.innerHTML = '<i class="fas fa-cog fa-spin"></i> Membuat halaman cover dengan QR Code...';
        progressFill.style.width = '25%';
        progressFill.textContent = '25%';
        
        const coverData = {
            formType: formType,
            shipName: shipName,
            date: new Date(date).toLocaleDateString('id-ID'),
            time: time,
            captain: captain,
            gt: gt,
            officer: officer,
            email: currentUser ? currentUser.email : '-'
        };
        
        const coverPdfBytes = await createCoverPage(coverData, finalFileUrl);
        const pdfFiles = [{ bytes: coverPdfBytes, name: 'Cover Page' }];
        
        statusDiv.innerHTML = `<i class="fas fa-cog fa-spin"></i> Menggabungkan ${filesToProcess.length} dokumen menjadi satu PDF...`;
        progressFill.style.width = '20%';
        progressFill.textContent = '20%';
        
        for (let i = 0; i < filesToProcess.length; i++) {
            const { file, label } = filesToProcess[i];
            
            statusDiv.innerHTML = `<i class="fas fa-cog fa-spin"></i> Memproses ${label} (${i + 1}/${filesToProcess.length})...`;
            
            if (file.type === 'application/pdf') {
                pdfFiles.push(file);
            } else if (file.type.startsWith('image/')) {
                const pdfBytes = await convertImageToPDF(file);
                pdfFiles.push({ bytes: pdfBytes, name: label });
            } else {
                console.warn(`Melewati file dengan format tidak didukung: ${file.type}`);
            }
        }
        
        statusDiv.innerHTML = '<i class="fas fa-cog fa-spin"></i> Menggabungkan semua halaman...';
        progressFill.style.width = '50%';
        progressFill.textContent = '50%';
        
        const mergedPdfBytes = await mergePDFs(pdfFiles);
        
        const mergedFileName = `[${formType}]_${shipName.replace(/\s+/g, '_')}_DOKUMEN_LENGKAP_${timestamp}.pdf`;
        
        const mergedBlob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
        const mergedFile = new File([mergedBlob], mergedFileName, { type: 'application/pdf' });
        
        statusDiv.innerHTML = '<i class="fas fa-upload"></i> Mengupload PDF gabungan final ke Google Drive...';
        progressFill.style.width = '75%';
        progressFill.textContent = '75%';
        
        const updateResponse = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${tempResult.id}?uploadType=media`, {
            method: 'PATCH',
            headers: new Headers({
                'Authorization': `Bearer ${currentAccessToken}`,
                'Content-Type': 'application/pdf'
            }),
            body: mergedBlob
        });
        
        if (!updateResponse.ok) {
            throw new Error('Gagal mengupdate file final');
        }
        
        await fetch(`https://www.googleapis.com/drive/v3/files/${tempResult.id}`, {
            method: 'PATCH',
            headers: new Headers({
                'Authorization': `Bearer ${currentAccessToken}`,
                'Content-Type': 'application/json'
            }),
            body: JSON.stringify({ name: mergedFileName })
        });
        
        const result = { id: tempResult.id };
        
        if (result.id) {
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
            
            const fileUrl = `https://drive.google.com/file/d/${result.id}/view`;
            
            statusDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> <strong>Berhasil!</strong> Dokumen gabungan telah diupload<br><br>
                ð <strong>File:</strong> ${mergedFileName}<br>
                ð <strong>Halaman Cover:</strong> Otomatis ditambahkan dengan QR Code<br>
                ð <strong>Total Halaman:</strong> 1 cover + ${filesToProcess.length} dokumen<br>
                ð <strong>Folder:</strong> ${formType}<br>
                ð¾ <strong>Ukuran:</strong> ${(mergedBlob.size / 1024).toFixed(2)} KB<br><br>
                <a href="${fileUrl}" target="_blank" style="color:#1a73e8;font-weight:bold;">ð Buka Dokumen di Google Drive</a>
            `;
            statusDiv.style.background = '#e8f5e8';
            statusDiv.style.borderColor = '#4caf50';
            statusDiv.style.color = '#2e7d32';
            
            const qrSection = form.nextElementSibling.querySelector('.qr-section');
            if (qrSection) {
                const qrInfo = qrSection.querySelector('.qr-info');
                if (qrInfo) {
                    qrInfo.innerHTML = `
                        <p><strong>â URL Dokumen PDF Gabungan:</strong></p>
                        <div class="qr-url">${fileUrl}</div>
                        <p><strong>File ID:</strong> ${result.id} | <strong>Folder:</strong> ${formType}</p>
                        <p style="color:#27ae60;font-weight:bold;">ð¯ Scan QR Code untuk membuka dokumen lengkap</p>
                        <button class="test-qr-btn success" onclick="copyToClipboard('${fileUrl.replace(/'/g, "\\'")}')">ð Copy Link</button>
                        <button class="test-qr-btn success" onclick="window.open('${fileUrl.replace(/'/g, "\\'")}', '_blank')">ð Buka PDF</button>
                    `;
                }
                
                const qrDiv = qrSection.querySelector('[id^="qrcode-"]');
                if (qrDiv) {
                    qrDiv.innerHTML = '';
                    try {
                        new QRCode(qrDiv, {
                            text: fileUrl,
                            width: 256,
                            height: 256,
                            colorDark: "#2c3e50",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    } catch (error) {
                        console.error('QR regeneration error:', error);
                        qrDiv.innerHTML = '<p style="color:red;">Error generating QR code</p>';
                    }
                }
            }
        } else {
            throw new Error('Upload gagal: Tidak ada file ID yang dikembalikan');
        }
        
    } catch (error) {
        console.error('Upload error:', error);
        errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`;
        errorDiv.style.display = 'block';
        statusDiv.style.display = 'none';
    } finally {
        btn.disabled = false;
        setTimeout(() => {
            progressBar.style.display = 'none';
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';
        }, 2000);
    }
}

function logout() {
    currentUser = null;
    currentAccessToken = null;
    
    if (currentAccessToken) {
        google.accounts.oauth2.revoke(currentAccessToken);
    }

    document.getElementById("loginPage").style.display = "flex";
    document.getElementById("dashboard").style.display = "none";
    document.body.style.background = "#f8f9fa";
    document.getElementById("mainContent").innerHTML = "";
}

function showPage(pageId, el) {
    document.querySelectorAll(".content-page").forEach(p => p.style.display = "none");
    const targetPage = document.getElementById(pageId);
    if (targetPage) targetPage.style.display = "block";
    
    document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
    if (el) el.classList.add("active");
}

const departurePetugasDocuments = ['SPB', 'Crew List', 'Perbekalan', 'SLO', 'Pernyataan Nahkoda', 'Kwitansi Tambat Labuh', 'Permohonan Penerbitan SPB', 'Daftar ABK', 'STBLKK', 'Faktur BBM'];
const departureNelayanDocuments = ['SPB', 'Crew List', 'Perbekalan', 'SLO', 'Pernyataan Nahkoda'];
const arrivalDocuments = ['STBLKK', 'Rekom Bongkar', 'SPB Asal'];

const menu = [
  {id:'departurePetugas', title:'â Petugas - Keberangkatan', type: 'departure', category: 'Petugas', docs: departurePetugasDocuments},
  {id:'arrivalPetugas', title:'â Petugas - Kedatangan', type: 'arrival', category: 'Petugas', docs: arrivalDocuments},
  {id:'departureNelayan', title:'ð¢ Nelayan - Keberangkatan', type: 'departure', category: 'Nelayan', docs: departureNelayanDocuments},
  {id:'arrivalNelayan', title:'ð¢ Nelayan - Kedatangan', type: 'arrival', category: 'Nelayan', docs: arrivalDocuments}
];

function initializePages() {
    const contentDiv = document.getElementById("mainContent");
    contentDiv.innerHTML = "";
    menu.forEach(m => {
        const div = document.createElement('div');
        div.id = m.id;
        div.className = 'content-page';
        const documentInputs = m.docs.map(doc => 
            `<label class="document-label">${doc}: <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required></label>`
        ).join('');
        div.innerHTML = `
            <h2>${m.title}</h2>
            <div class="card">
                <div class="form-type-indicator"><h3>ð Form ${m.category} - ${m.type === 'departure' ? 'Keberangkatan' : 'Kedatangan'}</h3></div>
                <div class="google-drive-status"><i class="fas fa-spinner fa-spin"></i> Menghubungkan...</div>
                <form data-form-type="${m.category}-${m.type === 'departure' ? 'Keberangkatan' : 'Kedatangan'}">
                    <input type="text" class="form-control" placeholder="Nama Kapal" required>
                    <div class="form-row">
                        <input type="date" class="form-control" required>
                        <input type="time" class="form-control" required>
                    </div>
                    <input type="text" class="form-control" placeholder="Nama Nahkoda" required>
                    <input type="text" class="form-control" placeholder="GT">
                    <select class="form-control" required>
                        <option value="" disabled selected>Pilih Petugas</option>
                        <option value="Iwan Ridwan, S.St.Pi.">Iwan Ridwan, S.St.Pi.</option>
                        <option value="Sepi Maharadika, S.St.Pi.">Sepi Maharadika, S.St.Pi.</option>
                        <option value="Akhmad Subarkah, S.Pi.">Akhmad Subarkah, S.Pi.</option>
                        <option value="Aprista Yanin Aniandita, S.St.Pi.">Aprista Yanin Aniandita, S.St.Pi.</option>
                        <option value="Adyaska Dzickry Robby, S.Tr.Pi.">Adyaska Dzickry Robby, S.Tr.Pi.</option>
                        <option value="Toni Sugiarto, S.Tr.Pi.">Toni Sugiarto, S.Tr.Pi.</option>
                        <option value="Fauzan Khotib, S.Tr.Pi.">Fauzan Khotib, S.Tr.Pi.</option>
                    </select>
                    <h4 style="margin:15px 0 10px;color:#2c3e50;">ð Upload Dokumen</h4>
                    ${documentInputs}
                    <button type="button" class="btn-generate" onclick="generateAll(this)">Generate QR & Preview</button>
                    <button type="button" class="btn-upload-drive" onclick="uploadToGoogleDrive(this)" disabled><i class="fab fa-google-drive"></i> Upload & Gabung ke Google Drive</button>
                    <div class="progress-bar"><div class="progress-fill" style="width: 0%;">0%</div></div>
                    <div class="upload-status"></div>
                    <div class="upload-error"></div>
                </form>
                <div class="result-container"></div>
            </div>
        `;
        contentDiv.appendChild(div);
    });
    const today = new Date().toISOString().split("T")[0];
    const now = new Date().toTimeString().slice(0, 5);
    document.querySelectorAll('input[type="date"]').forEach(input => input.value = today);
    document.querySelectorAll('input[type="time"]').forEach(input => input.value = now);
    setTimeout(() => {
        updateGoogleDriveStatus();
        enableUploadButtons();
    }, 100);
}

function generateAll(btn) {
    const form = btn.closest("form");
    const resultBox = form.nextElementSibling;
    const formType = form.getAttribute('data-form-type');
    resultBox.innerHTML = "";

    const inputs = form.querySelectorAll('input[type="text"]');
    const shipName = inputs[0]?.value || "KAPAL";
    const captain = inputs[1]?.value || "Nahkoda";
    const gt = inputs[2]?.value || "-";

    const date = form.querySelector('input[type="date"]').value || new Date().toISOString().split('T')[0];
    const time = form.querySelector('input[type="time"]').value || "00:00";
    const officerSelect = form.querySelector('select');
    const officer = officerSelect?.value || "Petugas tidak dipilih";

    const formattedDate = date.replace(/-/g, '');
    const formattedTime = time.replace(':', '');
    const code = `SANDAR-${shipName.replace(/\s+/g, '')}-${formattedDate}-${formattedTime}`;

    const summaryDiv = document.createElement("div");
    summaryDiv.className = "document-summary";
    summaryDiv.innerHTML = `
        <h3>ð Ringkasan Dokumen</h3>
        <table>
            <tr><td>Jenis Form:</td><td><strong>${formType}</strong></td></tr>
            <tr><td>Nama Kapal:</td><td>${shipName}</td></tr>
            <tr><td>Tanggal:</td><td>${new Date(date).toLocaleDateString('id-ID')}</td></tr>
            <tr><td>Waktu:</td><td>${time}</td></tr>
            <tr><td>Nahkoda:</td><td>${captain}</td></tr>
            <tr><td>GT:</td><td>${gt}</td></tr>
            <tr><td>Petugas:</td><td><strong>${officer}</strong></td></tr>
            <tr><td>Kode:</td><td><strong>${code}</strong></td></tr>
            <tr><td>Dibuat:</td><td>${new Date().toLocaleString('id-ID')}</td></tr>
        </table>
    `;
    resultBox.appendChild(summaryDiv);

    const qrSection = document.createElement("div");
    qrSection.className = "qr-section";
    qrSection.innerHTML = `<h3>ð± QR Code Dokumen</h3>`;
    const qrDiv = document.createElement("div");
    qrDiv.id = `qrcode-${Date.now()}`;
    qrSection.appendChild(qrDiv);

    const folderId = FOLDER_MAP[formType];
    const tempUrl = `https://drive.google.com/drive/folders/${folderId}`;
    const qrInfo = document.createElement("div");
    qrInfo.className = "qr-info";
    qrInfo.innerHTML = `
        <p><strong>â ï¸ QR Code Sementara</strong></p>
        <div class="qr-url">${tempUrl}</div>
        <p><strong>Folder:</strong> ${formType}</p>
        <p style="color:#e74c3c;font-weight:bold;">â¬ï¸ Klik tombol "Upload & Gabung ke Google Drive" untuk mendapatkan QR Code ke PDF final</p>
    `;
    qrSection.appendChild(qrInfo);
    resultBox.appendChild(qrSection);

    try {
        new QRCode(qrDiv, {
            text: tempUrl,
            width: 256,
            height: 256,
            colorDark: "#2c3e50",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
    } catch (error) {
        console.error('QR error:', error);
        qrDiv.innerHTML = '<p style="color:red;">Error generating QR</p>';
    }

    let docCount = 0;
    const fileInputs = form.querySelectorAll('input[type="file"]');
    fileInputs.forEach((fileInput) => {
        if (fileInput.files[0]) {
            docCount++;
            const file = fileInput.files[0];
            const label = fileInput.parentElement.textContent.split(':')[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewContainer = document.createElement("div");
                previewContainer.className = "preview-container";
                const docInfo = document.createElement("div");
                docInfo.className = "document-info";
                docInfo.innerHTML = `
                    <h4>${label}</h4>
                    <p>ð ${file.name} | ð ${(file.size/1024).toFixed(2)} KB<br>
                    <strong>Jenis: ${formType}</strong> | Petugas: ${officer}</p>
                `;
                previewContainer.appendChild(docInfo);
                let previewEl;
                if (file.type.includes("pdf")) {
                    previewEl = document.createElement("embed");
                    previewEl.src = e.target.result;
                    previewEl.type = "application/pdf";
                } else if (file.type.includes("image")) {
                    previewEl = document.createElement("img");
                    previewEl.src = e.target.result;
                    previewEl.alt = file.name;
                } else {
                    previewEl = document.createElement("div");
                    previewEl.innerHTML = `<p style="text-align:center;padding:50px;color:#7f8c8d;">ð ${file.name}<br><small>Preview tidak tersedia</small></p>`;
                }
                previewContainer.appendChild(previewEl);
                const downloadLink = document.createElement("a");
                downloadLink.href = e.target.result;
                downloadLink.download = `[${formType}]_${code}_${label}_${file.name}`;
                downloadLink.textContent = `â¬ Download ${label}`;
                previewContainer.appendChild(downloadLink);
                resultBox.appendChild(previewContainer);
            };
            reader.readAsDataURL(file);
        }
    });

    if (docCount === 0) {
        alert("Upload minimal satu dokumen!");
        return;
    }

    const uploadBtn = form.querySelector('.btn-upload-drive');
    if (uploadBtn && isGAPIReady) {
        uploadBtn.disabled = false;
    }
}
function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            alert('â URL berhasil disalin ke clipboard!');
        }).catch(() => {
            fallbackCopy(text);
        });
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    document.body.appendChild(textArea);
    textArea.select();
    try {
        document.execCommand('copy');
        alert('â URL berhasil disalin!');
    } catch (err) {
        alert('â Gagal menyalin URL');
    }
    document.body.removeChild(textArea);
}

document.addEventListener('DOMContentLoaded', function() {
    loadCustomLogo();
    
    logDebug('DOM loaded, checking Google APIs...');
    
    let checkCount = 0;
    const maxChecks = 10;
    
    const checkGoogleAPIs = setInterval(() => {
        checkCount++;
        logDebug(`Check attempt ${checkCount}/${maxChecks}`);
        
        if (typeof google !== 'undefined' && typeof google.accounts !== 'undefined') {
            clearInterval(checkGoogleAPIs);
            logDebug('â Google libraries loaded');
            initializeGoogle();
        } else if (checkCount >= maxChecks) {
            clearInterval(checkGoogleAPIs);
            logDebug('â Google APIs failed to load after ' + maxChecks + ' attempts');
            document.querySelector('.google-login-btn').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Google API tidak dapat dimuat';
            document.querySelector('.google-login-btn').disabled = true;
            
            const debugEl = document.getElementById('loginDebug');
            debugEl.innerHTML += '<br><strong>Troubleshooting:</strong><br>1. Periksa koneksi internet<br>2. Coba refresh halaman<br>3. Gunakan browser Chrome/Edge<br>4. Nonaktifkan AdBlock';
        }
    }, 500);
});
</script>
</body>
</html>
