<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SANDAR-RATU - Sistem Administrasi & Dokumen Kesyahbandaran</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;justify-content:center;align-items:center;}
.login-container{background:#fff;padding:40px;border-radius:15px;width:100%;max-width:420px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.15);}
.logo{width:80px;height:80px;margin:0 auto 15px;}
.login-title{font-size:22px;font-weight:600;margin-bottom:10px;color:#2c3e50;}
.subtitle{font-size:14px;color:#7f8c8d;margin-bottom:25px;}
.form-control{width:100%;padding:12px;margin-bottom:15px;border:1px solid #ddd;border-radius:8px;}
.btn-login{width:100%;padding:12px;border:none;border-radius:8px;background:#3498db;color:#fff;font-weight:bold;cursor:pointer;}
.btn-login:hover{background:#2980b9;}
.footer{font-size:12px;color:#7f8c8d;margin-top:20px;}
.dashboard{display:none;flex-direction:column;height:100vh;width:100%;}
.header{background:#2c3e50;color:white;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;}
.header .logo-icon{background:#3498db;width:36px;height:36px;border-radius:8px;display:flex;justify-content:center;align-items:center;margin-right:10px;}
.main-container{display:flex;flex:1;}
.sidebar{width:240px;background:#3498db;color:white;padding-top:20px;}
.sidebar div{padding:8px 20px;font-weight:600;opacity:0.8;font-size:13px;}
.sidebar a{display:flex;align-items:center;padding:12px 20px;color:white;text-decoration:none;transition:0.3s;cursor:pointer;}
.sidebar a:hover{background:rgba(255,255,255,0.1);}
.sidebar a.active{background:rgba(0,0,0,0.25);font-weight:bold;}
.content{flex:1;padding:25px;overflow-y:auto;background:#f5f5f5;}
.content h2{margin-bottom:20px;color:#2c3e50;}
.card{background:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.form-row{display:flex;gap:15px;margin-bottom:15px;}
.form-row .form-control{flex:1;}
.btn-generate{width:100%;padding:12px;background:#2ecc71;border:none;color:white;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:10px;}
.btn-generate:hover{background:#27ae60;}
.result-container{margin-top:15px;}
.preview-container{margin-top:8px;padding:15px;background:#fafafa;border:1px solid #ddd;border-radius:6px;display:flex;flex-direction:column;gap:10px;}
.preview-container .document-info{background:#fff;padding:10px;border-radius:5px;border-left:4px solid #3498db;}
.preview-container .document-info h4{color:#2c3e50;margin-bottom:5px;}
.preview-container .document-info p{color:#7f8c8d;font-size:12px;}
.preview-container embed,.preview-container img{width:100%;max-height:300px;border-radius:6px;object-fit:contain;border:1px solid #ddd;}
.preview-container a{align-self:flex-start;text-decoration:none;color:#2980b9;font-weight:bold;padding:5px 10px;background:#ecf0f1;border-radius:4px;}
.qr-section{background:#fff;padding:15px;border-radius:8px;text-align:center;border:2px solid #3498db;margin-bottom:15px;}
.qr-section h3{color:#2c3e50;margin-bottom:10px;}
.qr-info{background:#e8f6ff;padding:10px;border-radius:6px;margin-top:10px;border:1px solid #3498db;}
.qr-info p{margin:3px 0;font-size:12px;color:#2c3e50;}
.qr-info .qr-url{background:#fff;padding:8px;margin:5px 0;border-radius:4px;word-break:break-all;font-family:monospace;font-size:13px;border:1px solid #bdc3c7;max-height:60px;overflow-y:auto;}
.document-summary{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #27ae60;}
.document-summary h3{color:#2c3e50;margin-bottom:10px;}
.document-summary table{width:100%;border-collapse:collapse;}
.document-summary table td{padding:5px;border-bottom:1px solid #ecf0f1;}
.document-summary table td:first-child{font-weight:bold;width:30%;}
.form-type-indicator{background:#e8f4f8;border:2px solid #3498db;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;}
.form-type-indicator h3{color:#2c3e50;margin:0;}
.test-qr-btn{background:#e74c3c;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin:5px;font-size:12px;}
.test-qr-btn:hover{background:#c0392b;}

/* Verification Page Styles */
.verification-page{display:none;min-height:100vh;background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;}
.verification-container{background:#fff;max-width:800px;margin:0 auto;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.15);}
.verification-header{background:#2c3e50;color:white;padding:20px;text-align:center;}
.verification-content{padding:30px;}
.verification-status{text-align:center;margin-bottom:30px;}
.status-valid{color:#27ae60;background:#d5f4e6;border:2px solid #27ae60;padding:15px;border-radius:8px;}
.status-invalid{color:#e74c3c;background:#fdf2f2;border:2px solid:#e74c3c;padding:15px;border-radius:8px;}
.document-details{background:#f8f9fa;padding:20px;border-radius:8px;margin:20px 0;}
.document-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-top:20px;}
.document-item{background:#fff;border:1px solid #ddd;border-radius:8px;padding:15px;}
.document-item h4{color:#2c3e50;margin-bottom:10px;}

/* Storage Archive Styles */
.storage-container{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;}
.storage-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #3498db;}
.storage-filters{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.storage-filters select,.storage-filters input{padding:8px 12px;border:1px solid #ddd;border-radius:5px;}
.storage-item{background:#f8f9fa;border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:15px;position:relative;}
.storage-item.highlighted{border-left:4px solid #3498db;background:#e8f4f8;}
.storage-item-header{display:flex;justify-content:between;align-items:flex-start;margin-bottom:10px;}
.storage-item-title{font-weight:bold;color:#2c3e50;margin-bottom:5px;}
.storage-item-meta{font-size:12px;color:#7f8c8d;margin-bottom:10px;}
.storage-item-actions{position:absolute;top:15px;right:15px;}
.btn-small{padding:5px 10px;font-size:12px;border:none;border-radius:4px;cursor:pointer;margin-left:5px;}
.btn-view{background:#3498db;color:white;}
.btn-download{background:#27ae60;color:white;}
.btn-delete{background:#e74c3c;color:white;}
.document-count{background:#3498db;color:white;padding:2px 8px;border-radius:10px;font-size:11px;}
.search-box{width:200px;}
.pagination{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;}
.pagination button{padding:8px 12px;border:1px solid #ddd;background:#fff;cursor:pointer;border-radius:4px;}
.pagination button.active{background:#3498db;color:white;border-color:#3498db;}
.pagination button:disabled{background:#f5f5f5;color:#999;cursor:not-allowed;}
</style>
</head>
<body>

<!-- VERIFICATION PAGE -->
<div id="verificationPage" class="verification-page">
  <div class="verification-container">
    <div class="verification-header">
      <div style="display:flex;align-items:center;justify-content:center;">
        <i class="fas fa-anchor fa-2x" style="margin-right:15px;"></i>
        <div>
          <h1>SANDAR-RATU</h1>
          <p>Sistem Verifikasi Dokumen Kesyahbandaran</p>
        </div>
      </div>
    </div>
    <div class="verification-content">
      <div id="verificationResult"></div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="loginPage" class="login-container">
  <div class="logo"><i class="fas fa-anchor fa-3x" style="color:#3498db;"></i></div>
  <h2 class="login-title">SANDAR-RATU</h2>
  <p class="subtitle">üìã Sistem Administrasi & Dokumen<br>Kesyahbandaran PPN Palabuhanratu</p>
  <form id="loginForm">
    <input type="text" id="username" class="form-control" placeholder="Nama Pengguna / Email" required>
    <input type="password" id="password" class="form-control" placeholder="Kata Sandi" required>
    <button type="submit" class="btn-login">Masuk</button>
  </form>
  <div class="footer">Hak Cipta ¬© 2025 Sandar-Ratu</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="dashboard">
  <div class="header">
    <div style="display:flex;align-items:center;">
      <div class="logo-icon"><i class="fas fa-anchor"></i></div>
      <strong>SANDAR-RATU</strong>
    </div>
    <button onclick="logout()" style="background:#e74c3c;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;">Keluar</button>
  </div>
  <div class="main-container">
    <div class="sidebar">
      <div>üë®‚Äç‚úàÔ∏è Petugas</div>
      <a onclick="showPage('departurePetugas', this)"><i class="fas fa-anchor"></i>&nbsp; Keberangkatan</a>
      <a onclick="showPage('arrivalPetugas', this)"><i class="fas fa-ship"></i>&nbsp; Kedatangan</a>
      <a onclick="showPage('storagePetugas', this)"><i class="fas fa-archive"></i>&nbsp; Arsip Dokumen</a>
      <div>üö¢ Nelayan</div>
      <a onclick="showPage('departureNelayan', this)"><i class="fas fa-fish"></i>&nbsp; Keberangkatan</a>
      <a onclick="showPage('arrivalNelayan', this)"><i class="fas fa-water"></i>&nbsp; Kedatangan</a>
      <a onclick="showPage('storageNelayan', this)"><i class="fas fa-archive"></i>&nbsp; Arsip Dokumen</a>
    </div>

    <div class="content">
      <script>
        // Global storage untuk dokumen
        let documentStorage = {
          petugas: [],
          nelayan: []
        };

        const menu = [
          {id:'departurePetugas', title:'‚öì Petugas - Keberangkatan', type: 'departure', category: 'Petugas'},
          {id:'arrivalPetugas', title:'‚öì Petugas - Kedatangan', type: 'arrival', category: 'Petugas'},
          {id:'storagePetugas', title:'üìÅ Arsip Dokumen Petugas', type: 'storage', category: 'Petugas'},
          {id:'departureNelayan', title:'üö¢ Nelayan - Keberangkatan', type: 'departure', category: 'Nelayan'},
          {id:'arrivalNelayan', title:'üö¢ Nelayan - Kedatangan', type: 'arrival', category: 'Nelayan'},
          {id:'storageNelayan', title:'üìÅ Arsip Dokumen Nelayan', type: 'storage', category: 'Nelayan'}
        ];

        // Dokumen untuk petugas keberangkatan
        const departurePetugasDocuments = [
          'SPB',
          'Crew List', 
          'Perbekalan',
          'SLO',
          'Pernyataan Nahkoda',
          'Kwitansi Tambat Labuh',
          'Permohonan Penerbitan SPB',
          'Daftar ABK',
          'STBLKK',
          'Faktur BBM'
        ];

        // Dokumen untuk nelayan keberangkatan
        const departureNelayanDocuments = [
          'SPB',
          'Crew List', 
          'Perbekalan',
          'SLO',
          'Pernyataan Nahkoda'
        ];

        // Dokumen untuk kedatangan (sama untuk petugas dan nelayan)
        const arrivalDocuments = [
          'STBLKK',
          'Rekom Bongkar',
          'SPB Asal'
        ];

        menu.forEach(m=>{
          const div = document.createElement('div');
          div.id = m.id;
          div.className = 'content-page';
          if(m.id!=='departurePetugas') div.style.display='none';
          
          if(m.type === 'storage') {
            // Halaman arsip dokumen
            div.innerHTML = `
              <h2>${m.title}</h2>
              <div class="storage-container">
                <div class="storage-header">
                  <div>
                    <h3><i class="fas fa-archive"></i> Arsip Dokumen ${m.category}</h3>
                    <p style="margin:5px 0;color:#7f8c8d;font-size:14px;">Kelola dan cari dokumen yang telah disimpan</p>
                  </div>
                  <div style="display:flex;gap:10px;align-items:center;">
                    <span id="totalDocs-${m.category.toLowerCase()}" class="document-count">0 Dokumen</span>
                    <button onclick="exportStorage('${m.category.toLowerCase()}')" class="btn-small btn-download">
                      <i class="fas fa-download"></i> Export
                    </button>
                    <button onclick="clearStorage('${m.category.toLowerCase()}')" class="btn-small btn-delete">
                      <i class="fas fa-trash"></i> Clear All
                    </button>
                  </div>
                </div>
                
                <div class="storage-filters">
                  <select onchange="filterStorage('${m.category.toLowerCase()}')">
                    <option value="">Semua Jenis</option>
                    <option value="departure">Keberangkatan</option>
                    <option value="arrival">Kedatangan</option>
                  </select>
                  
                  <input type="date" onchange="filterStorage('${m.category.toLowerCase()}')" placeholder="Tanggal">
                  
                  <input type="text" class="search-box" placeholder="Cari kapal, kapten..." onkeyup="filterStorage('${m.category.toLowerCase()}')" maxlength="50">
                  
                  <select onchange="filterStorage('${m.category.toLowerCase()}')">
                    <option value="newest">Terbaru</option>
                    <option value="oldest">Terlama</option>
                    <option value="name">Nama Kapal</option>
                  </select>
                </div>
                
                <div id="storageList-${m.category.toLowerCase()}">
                  <div style="text-align:center;padding:40px;color:#7f8c8d;">
                    <i class="fas fa-inbox fa-3x" style="margin-bottom:15px;"></i>
                    <p>Belum ada dokumen tersimpan</p>
                    <p style="font-size:12px;margin-top:5px;">Dokumen akan muncul setelah Anda generate dan simpan dari form keberangkatan/kedatangan</p>
                  </div>
                </div>
                
                <div class="pagination" id="pagination-${m.category.toLowerCase()}" style="display:none;">
                  <button onclick="changePage('${m.category.toLowerCase()}', -1)">‚ùÆ Prev</button>
                  <span id="pageInfo-${m.category.toLowerCase()}">1 / 1</span>
                  <button onclick="changePage('${m.category.toLowerCase()}', 1)">Next ‚ùØ</button>
                </div>
              </div>
            `;
          } else {
            // Halaman form biasa
            let documents;
            if (m.type === 'arrival') {
              documents = arrivalDocuments;
            } else if (m.id === 'departurePetugas') {
              documents = departurePetugasDocuments;
            } else if (m.id === 'departureNelayan') {
              documents = departureNelayanDocuments;
            } else {
              documents = departurePetugasDocuments;
            }
            
            const documentInputs = documents.map(doc => 
              `<label>${doc}: <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required></label>`
            ).join('');

            div.innerHTML = `
              <h2>${m.title}</h2>
              <div class="card">
                <div class="form-type-indicator">
                  <h3>üìã Form ${m.category} - ${m.type === 'departure' ? 'Keberangkatan' : 'Kedatangan'}</h3>
                </div>
                <form data-form-type="${m.category}-${m.type === 'departure' ? 'Keberangkatan' : 'Kedatangan'}" data-category="${m.category.toLowerCase()}">
                  <input type="text" class="form-control" placeholder="Nama Kapal" required maxlength="50">
                  <div class="form-row">
                    <input type="date" class="form-control" required>
                    <input type="time" class="form-control" required>
                  </div>
                  <input type="text" class="form-control" placeholder="Kapten Kapal" required maxlength="50">
                  <input type="text" class="form-control" placeholder="GT (Opsional)" maxlength="20">
                  <h4 style="margin:15px 0 10px;color:#2c3e50;">üìé Upload Dokumen</h4>
                  ${documentInputs}
                  <button type="button" class="btn-generate" onclick="generateAll(this)">Generate QR & Preview</button>
                  <button type="button" class="btn-generate" onclick="downloadAll(this)">‚¨á Download Semua Dokumen + QR PDF</button>
                  <button type="button" class="btn-generate" onclick="saveToStorage(this)" style="background:#f39c12;">üíæ Simpan ke Arsip</button>
                </form>
                <div class="result-container"></div>
              </div>
            `;
          }
          
          document.querySelector('.content').appendChild(div);
        });
      </script>
    </div>
  </div>
</div>

<script>
// Check for verification URL parameters on page load
window.addEventListener('load', function() {
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('code')) {
    showVerificationPage(urlParams);
  }
});

function showVerificationPage(urlParams) {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('verificationPage').style.display = 'block';
  document.body.style.background = 'transparent';
  
  const code = urlParams.get('code');
  const type = urlParams.get('type');
  const ship = urlParams.get('ship');
  const date = urlParams.get('date');
  const time = urlParams.get('time');
  const captain = urlParams.get('captain');
  const gt = urlParams.get('gt');
  
  const resultDiv = document.getElementById('verificationResult');
  
  // Simulasi verifikasi (dalam implementasi nyata, ini akan check database)
  const isValid = code && type && ship && date;
  
  if (isValid) {
    resultDiv.innerHTML = `
      <div class="verification-status status-valid">
        <h2><i class="fas fa-check-circle"></i> Dokumen Valid</h2>
        <p>Dokumen telah terverifikasi dan sah</p>
      </div>
      
      <div class="document-details">
        <h3><i class="fas fa-info-circle"></i> Detail Dokumen</h3>
        <table style="width:100%;border-collapse:collapse;">
          <tr><td style="padding:8px;border-bottom:1px solid #ddd;font-weight:bold;">Kode Dokumen:</td><td style="padding:8px;border-bottom:1px solid #ddd;">${code}</td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #ddd;font-weight:bold;">Jenis Form:</td><td style="padding:8px;border-bottom:1px solid #ddd;"><span style="background:#3498db;color:white;padding:3px 8px;border-radius:4px;">${type}</span></td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #ddd;font-weight:bold;">Nama Kapal:</td><td style="padding:8px;border-bottom:1px solid #ddd;">${ship}</td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #ddd;font-weight:bold;">Tanggal:</td><td style="padding:8px;border-bottom:1px solid #ddd;">${new Date(date).toLocaleDateString('id-ID', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #ddd;font-weight:bold;">Waktu:</td><td style="padding:8px;border-bottom:1px solid #ddd;">${time} WIB</td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #ddd;font-weight:bold;">Kapten:</td><td style="padding:8px;border-bottom:1px solid #ddd;">${captain}</td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #ddd;font-weight:bold;">GT:</td><td style="padding:8px;border-bottom:1px solid #ddd;">${gt || 'Tidak disebutkan'}</td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #ddd;font-weight:bold;">Status:</td><td style="padding:8px;border-bottom:1px solid #ddd;"><span style="color:#27ae60;font-weight:bold;">‚úÖ Aktif & Valid</span></td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #ddd;font-weight:bold;">Diverifikasi:</td><td style="padding:8px;border-bottom:1px solid #ddd;">${new Date().toLocaleString('id-ID')}</td></tr>
        </table>
      </div>
      
      <div style="background:#fff3cd;border:1px solid #ffeaa7;padding:15px;border-radius:8px;margin:20px 0;">
        <h4 style="color:#856404;margin-bottom:10px;"><i class="fas fa-exclamation-triangle"></i> Catatan Penting</h4>
        <ul style="margin:0;padding-left:20px;color:#856404;">
          <li>Dokumen ini telah diverifikasi oleh sistem SANDAR-RATU</li>
          <li>Untuk verifikasi lebih lanjut, hubungi PPN Palabuhanratu</li>
          <li>Simpan halaman ini sebagai bukti verifikasi</li>
        </ul>
      </div>
      
      <div style="text-align:center;margin-top:30px;">
        <button onclick="window.print()" style="background:#3498db;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;margin:5px;">
          <i class="fas fa-print"></i> Cetak Verifikasi
        </button>
        <button onclick="window.location.href=window.location.origin" style="background:#95a5a6;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;margin:5px;">
          <i class="fas fa-home"></i> Kembali ke Beranda
        </button>
      </div>
    `;
  } else {
    resultDiv.innerHTML = `
      <div class="verification-status status-invalid">
        <h2><i class="fas fa-times-circle"></i> Dokumen Tidak Valid</h2>
        <p>Dokumen tidak dapat diverifikasi atau data tidak lengkap</p>
      </div>
      
      <div style="background:#f8d7da;border:1px solid #f5c6cb;padding:15px;border-radius:8px;margin:20px 0;">
        <h4 style="color:#721c24;margin-bottom:10px;"><i class="fas fa-exclamation-triangle"></i> Kemungkinan Penyebab</h4>
        <ul style="margin:0;padding-left:20px;color:#721c24;">
          <li>QR Code rusak atau tidak terbaca dengan benar</li>
          <li>Dokumen belum terdaftar dalam sistem</li>
          <li>URL verifikasi tidak valid atau sudah kedaluwarsa</li>
          <li>Terjadi masalah pada sistem</li>
        </ul>
      </div>
      
      <div style="text-align:center;margin-top:30px;">
        <button onclick="window.location.href=window.location.origin" style="background:#3498db;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;margin:5px;">
          <i class="fas fa-home"></i> Kembali ke Beranda
        </button>
        <button onclick="window.location.href='tel:+62123456789'" style="background:#e74c3c;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;margin:5px;">
          <i class="fas fa-phone"></i> Hubungi Support
        </button>
      </div>
    `;
  }
}

document.getElementById("loginForm").addEventListener("submit",function(e){
  e.preventDefault();
  if(document.getElementById("username").value && document.getElementById("password").value){
    document.getElementById("loginPage").style.display="none";
    document.getElementById("dashboard").style.display="flex";
    document.body.style.background="white";
    showPage('departurePetugas', document.querySelector(".sidebar a"));
    loadStorageData();
  } else { alert("Isi username & password!"); }
});

function logout(){
  document.getElementById("dashboard").style.display="none";
  document.getElementById("loginPage").style.display="block";
  document.body.style.background="linear-gradient(135deg,#667eea,#764ba2)";
}

function showPage(pageId, el){
  document.querySelectorAll(".content-page").forEach(p=>p.style.display="none");
  document.getElementById(pageId).style.display="block";
  document.querySelectorAll(".sidebar a").forEach(a=>a.classList.remove("active"));
  if(el){ el.classList.add("active"); }
  
  // Load storage data when showing storage pages
  if(pageId.includes('storage')) {
    const category = pageId.replace('storage', '').toLowerCase();
    updateStorageDisplay(category);
  }
}

// Storage Management Functions
let currentPage = {petugas: 1, nelayan: 1};
let itemsPerPage = 5;
let currentFilter = {petugas: {}, nelayan: {}};

function saveToStorage(btn) {
  const form = btn.closest("form");
  const category = form.getAttribute('data-category');
  const formType = form.getAttribute('data-form-type');
  
  // Validasi form
  const shipName = form.querySelector('input[type="text"]').value;
  const date = form.querySelector('input[type="date"]').value;
  const time = form.querySelector('input[type="time"]').value;
  const captain = form.querySelectorAll('input[type="text"]')[1].value;
  const gt = form.querySelectorAll('input[type="text"]')[2].value || "-";
  
  if (!shipName || !date || !time || !captain) {
    alert("Mohon lengkapi semua data terlebih dahulu!");
    return;
  }
  
  // Check if documents are uploaded
  const fileInputs = form.querySelectorAll('input[type="file"]');
  let uploadedDocs = [];
  let hasFiles = false;
  
  fileInputs.forEach((fileInput) => {
    if(fileInput.files[0]) {
      hasFiles = true;
      const file = fileInput.files[0];
      const label = fileInput.parentElement.textContent.split(':')[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedDocs.push({
          name: label,
          fileName: file.name,
          size: file.size,
          type: file.type,
          data: e.target.result
        });
      };
      reader.readAsDataURL(file);
    }
  });
  
  if (!hasFiles) {
    alert("Mohon upload minimal satu dokumen!");
    return;
  }
  
  // Wait for all files to be read
  setTimeout(() => {
    const formattedDate = date.replace(/-/g,'');
    const formattedTime = time.replace(':','');
    const code = `SANDAR-${shipName.replace(/\s+/g,'')}-${formattedDate}-${formattedTime}`;
    
    const documentData = {
      id: Date.now(),
      code: code,
      formType: formType,
      shipName: shipName,
      date: date,
      time: time,
      captain: captain,
      gt: gt,
      documents: uploadedDocs,
      createdAt: new Date().toISOString(),
      qrUrl: generateQRUrl(code, formType, shipName, date, time, captain, gt)
    };
    
    // Save to storage
    documentStorage[category].push(documentData);
    saveStorageToLocalStorage();
    
    alert(`Dokumen berhasil disimpan ke arsip ${category}!\nKode: ${code}\nJumlah dokumen: ${uploadedDocs.length}`);
    
    // Update display if on storage page
    updateStorageDisplay(category);
  }, 1000);
}

function generateQRUrl(code, formType, shipName, date, time, captain, gt) {
  const baseUrl = window.location.origin + window.location.pathname;
  const params = new URLSearchParams({
    code: code,
    type: formType,
    ship: shipName,
    date: date,
    time: time,
    captain: captain,
    gt: gt
  });
  return `${baseUrl}?${params.toString()}`;
}

function updateStorageDisplay(category) {
  const listContainer = document.getElementById(`storageList-${category}`);
  const totalDocsSpan = document.getElementById(`totalDocs-${category}`);
  const paginationDiv = document.getElementById(`pagination-${category}`);
  
  let filteredData = applyFilters(category);
  const totalItems = filteredData.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage[category] - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentItems = filteredData.slice(startIndex, endIndex);
  
  // Update total count
  totalDocsSpan.textContent = `${totalItems} Dokumen`;
  
  if (currentItems.length === 0) {
    listContainer.innerHTML = `
      <div style="text-align:center;padding:40px;color:#7f8c8d;">
        <i class="fas fa-search fa-3x" style="margin-bottom:15px;"></i>
        <p>Tidak ada dokumen ditemukan</p>
        <p style="font-size:12px;margin-top:5px;">Coba ubah filter pencarian atau tambah dokumen baru</p>
      </div>
    `;
    paginationDiv.style.display = 'none';
  } else {
    listContainer.innerHTML = currentItems.map(doc => `
      <div class="storage-item" id="doc-${doc.id}">
        <div class="storage-item-actions">
          <button class="btn-small btn-view" onclick="viewDocument(${doc.id}, '${category}')" title="Lihat Detail">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn-small btn-download" onclick="downloadFromStorage(${doc.id}, '${category}')" title="Download">
            <i class="fas fa-download"></i>
          </button>
          <button class="btn-small btn-delete" onclick="deleteDocument(${doc.id}, '${category}')" title="Hapus">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        
        <div class="storage-item-title">
          üö¢ ${doc.shipName} - ${doc.formType}
        </div>
        
        <div class="storage-item-meta">
          <span><i class="fas fa-calendar"></i> ${new Date(doc.date).toLocaleDateString('id-ID')}</span> |
          <span><i class="fas fa-clock"></i> ${doc.time}</span> |
          <span><i class="fas fa-user"></i> ${doc.captain}</span> |
          <span><i class="fas fa-weight"></i> ${doc.gt} GT</span>
        </div>
        
        <div style="margin:10px 0;">
          <span class="document-count">${doc.documents.length} Dokumen</span>
          <span style="background:#95a5a6;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:5px;">
            ${doc.code}
          </span>
        </div>
        
        <div style="font-size:12px;color:#7f8c8d;">
          Dibuat: ${new Date(doc.createdAt).toLocaleString('id-ID')}
        </div>
        
        <div style="margin-top:10px;">
          ${doc.documents.slice(0, 3).map(d => `<span style="background:#ecf0f1;padding:2px 6px;border-radius:3px;font-size:11px;margin-right:5px;">${d.name}</span>`).join('')}
          ${doc.documents.length > 3 ? `<span style="color:#7f8c8d;font-size:11px;">+${doc.documents.length - 3} lainnya</span>` : ''}
        </div>
      </div>
    `).join('');
    
    // Update pagination
    if (totalPages > 1) {
      paginationDiv.style.display = 'flex';
      document.getElementById(`pageInfo-${category}`).textContent = `${currentPage[category]} / ${totalPages}`;
      const prevBtn = paginationDiv.querySelector('button:first-child');
      const nextBtn = paginationDiv.querySelector('button:last-child');
      prevBtn.disabled = currentPage[category] === 1;
      nextBtn.disabled = currentPage[category] === totalPages;
    } else {
      paginationDiv.style.display = 'none';
    }
  }
}

function applyFilters(category) {
  let data = [...documentStorage[category]];
  const filters = currentFilter[category];
  
  // Filter by type
  if (filters.type) {
    data = data.filter(doc => doc.formType.toLowerCase().includes(filters.type.toLowerCase()));
  }
  
  // Filter by date
  if (filters.date) {
    data = data.filter(doc => doc.date === filters.date);
  }
  
  // Filter by search text
  if (filters.search) {
    const search = filters.search.toLowerCase();
    data = data.filter(doc => 
      doc.shipName.toLowerCase().includes(search) ||
      doc.captain.toLowerCase().includes(search) ||
      doc.code.toLowerCase().includes(search)
    );
  }
  
  // Sort data
  const sortBy = filters.sort || 'newest';
  switch(sortBy) {
    case 'newest':
      data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      break;
    case 'oldest':
      data.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
      break;
    case 'name':
      data.sort((a, b) => a.shipName.localeCompare(b.shipName));
      break;
  }
  
  return data;
}

function filterStorage(category) {
  const page = document.getElementById(`storage${category.charAt(0).toUpperCase() + category.slice(1)}`);
  const selects = page.querySelectorAll('select');
  const dateInput = page.querySelector('input[type="date"]');
  const searchInput = page.querySelector('.search-box');
  
  currentFilter[category] = {
    type: selects[0].value,
    sort: selects[1].value,
    date: dateInput.value,
    search: searchInput.value
  };
  
  currentPage[category] = 1; // Reset to first page
  updateStorageDisplay(category);
}

function changePage(category, direction) {
  const filteredData = applyFilters(category);
  const totalPages = Math.ceil(filteredData.length / itemsPerPage);
  
  const newPage = currentPage[category] + direction;
  if (newPage >= 1 && newPage <= totalPages) {
    currentPage[category] = newPage;
    updateStorageDisplay(category);
  }
}

function viewDocument(docId, category) {
  const doc = documentStorage[category].find(d => d.id === docId);
  if (!doc) return;
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);
    display:flex;justify-content:center;align-items:center;z-index:1000;
  `;
  
  modal.innerHTML = `
    <div style="background:white;padding:30px;border-radius:15px;max-width:800px;width:90%;max-height:90%;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="margin:0;color:#2c3e50;">üìÑ Detail Dokumen</h2>
        <button onclick="this.closest('.modal').remove()" style="background:#e74c3c;color:white;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;">
          ‚úï Tutup
        </button>
      </div>
      
      <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
        <h3 style="margin-bottom:15px;color:#2c3e50;">${doc.shipName} - ${doc.formType}</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
          <div><strong>Kode:</strong><br>${doc.code}</div>
          <div><strong>Tanggal:</strong><br>${new Date(doc.date).toLocaleDateString('id-ID')}</div>
          <div><strong>Waktu:</strong><br>${doc.time}</div>
          <div><strong>Kapten:</strong><br>${doc.captain}</div>
          <div><strong>GT:</strong><br>${doc.gt}</div>
          <div><strong>Dibuat:</strong><br>${new Date(doc.createdAt).toLocaleString('id-ID')}</div>
        </div>
      </div>
      
      <div style="margin-bottom:20px;">
        <h4 style="margin-bottom:15px;color:#2c3e50;"><i class="fas fa-qrcode"></i> QR Code Verifikasi</h4>
        <div style="text-align:center;background:#f8f9fa;padding:15px;border-radius:8px;">
          <div id="qr-modal-${docId}"></div>
          <p style="margin-top:10px;font-size:12px;color:#7f8c8d;">Scan untuk verifikasi dokumen</p>
          <button onclick="copyToClipboard('${doc.qrUrl}')" style="background:#3498db;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-top:10px;">
            üìã Copy URL
          </button>
        </div>
      </div>
      
      <div>
        <h4 style="margin-bottom:15px;color:#2c3e50;"><i class="fas fa-file"></i> Dokumen (${doc.documents.length})</h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;">
          ${doc.documents.map((d, i) => `
            <div style="border:1px solid #ddd;border-radius:8px;padding:15px;background:#fff;">
              <h5 style="margin:0 0 10px;color:#2c3e50;">${d.name}</h5>
              <p style="font-size:12px;color:#7f8c8d;margin:5px 0;">üìÑ ${d.fileName}</p>
              <p style="font-size:12px;color:#7f8c8d;margin:5px 0;">üìè ${(d.size/1024).toFixed(2)} KB</p>
              ${d.type.includes('image') ? `<img src="${d.data}" style="width:100%;height:120px;object-fit:cover;border-radius:4px;margin:10px 0;">` : ''}
              <button onclick="downloadSingleDoc(${docId}, ${i}, '${category}')" style="background:#27ae60;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;width:100%;">
                ‚¨á Download
              </button>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  
  modal.className = 'modal';
  document.body.appendChild(modal);
  
  // Generate QR in modal
  setTimeout(() => {
    new QRCode(document.getElementById(`qr-modal-${docId}`), {
      text: doc.qrUrl,
      width: 150,
      height: 150,
      colorDark: "#2c3e50",
      colorLight: "#ffffff"
    });
  }, 100);
}

function downloadSingleDoc(docId, docIndex, category) {
  const doc = documentStorage[category].find(d => d.id === docId);
  if (!doc || !doc.documents[docIndex]) return;
  
  const document_data = doc.documents[docIndex];
  const link = document.createElement('a');
  link.href = document_data.data;
  link.download = `[${doc.formType}]_${doc.code}_${document_data.name}_${document_data.fileName}`;
  link.click();
}

function downloadFromStorage(docId, category) {
  const doc = documentStorage[category].find(d => d.id === docId);
  if (!doc) return;
  
  // Create ZIP-like download by downloading all documents
  doc.documents.forEach((d, index) => {
    setTimeout(() => {
      const link = document.createElement('a');
      link.href = d.data;
      link.download = `[${doc.formType}]_${doc.code}_${d.name}_${d.fileName}`;
      link.click();
    }, index * 500); // Staggered download
  });
  
  alert(`Memulai download ${doc.documents.length} dokumen dari ${doc.shipName}`);
}

function deleteDocument(docId, category) {
  const doc = documentStorage[category].find(d => d.id === docId);
  if (!doc) return;
  
  if (confirm(`Hapus dokumen ${doc.shipName} - ${doc.formType}?\nTindakan ini tidak dapat dibatalkan.`)) {
    documentStorage[category] = documentStorage[category].filter(d => d.id !== docId);
    saveStorageToLocalStorage();
    updateStorageDisplay(category);
    alert('Dokumen berhasil dihapus!');
  }
}

function exportStorage(category) {
  const data = documentStorage[category];
  if (data.length === 0) {
    alert('Tidak ada data untuk diekspor!');
    return;
  }
  
  // Create CSV export
  const csvContent = [
    ['Kode', 'Jenis Form', 'Nama Kapal', 'Tanggal', 'Waktu', 'Kapten', 'GT', 'Jumlah Dokumen', 'Dibuat'].join(','),
    ...data.map(doc => [
      doc.code,
      doc.formType,
      doc.shipName,
      doc.date,
      doc.time,
      doc.captain,
      doc.gt,
      doc.documents.length,
      new Date(doc.createdAt).toLocaleString('id-ID')
    ].join(','))
  ].join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `SANDAR_RATU_Arsip_${category.toUpperCase()}_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  alert(`Data arsip ${category} berhasil diekspor ke CSV!`);
}

function clearStorage(category) {
  if (documentStorage[category].length === 0) {
    alert('Tidak ada data untuk dihapus!');
    return;
  }
  
  if (confirm(`Hapus semua ${documentStorage[category].length} dokumen dari arsip ${category}?\nTindakan ini tidak dapat dibatalkan!`)) {
    documentStorage[category] = [];
    saveStorageToLocalStorage();
    updateStorageDisplay(category);
    alert(`Semua dokumen ${category} berhasil dihapus!`);
  }
}

function saveStorageToLocalStorage() {
  try {
    const data = JSON.stringify(documentStorage);
    // Split large data into chunks to avoid localStorage limits
    const chunkSize = 1024 * 1024; // 1MB chunks
    const chunks = Math.ceil(data.length / chunkSize);
    
    // Clear old chunks
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith('sandar_storage_chunk_')) {
        localStorage.removeItem(key);
      }
    });
    
    // Save new chunks
    for (let i = 0; i < chunks; i++) {
      const chunk = data.slice(i * chunkSize, (i + 1) * chunkSize);
      localStorage.setItem(`sandar_storage_chunk_${i}`, chunk);
    }
    
    localStorage.setItem('sandar_storage_chunks', chunks.toString());
  } catch (e) {
    console.warn('LocalStorage limit reached, data not saved:', e);
    alert('Penyimpanan penuh! Beberapa dokumen mungkin tidak tersimpan. Pertimbangkan untuk export dan hapus dokumen lama.');
  }
}

function loadStorageData() {
  try {
    const chunks = parseInt(localStorage.getItem('sandar_storage_chunks') || '0');
    if (chunks === 0) return;
    
    let data = '';
    for (let i = 0; i < chunks; i++) {
      data += localStorage.getItem(`sandar_storage_chunk_${i}`) || '';
    }
    
    if (data) {
      documentStorage = JSON.parse(data);
    }
  } catch (e) {
    console.warn('Error loading storage data:', e);
    documentStorage = { petugas: [], nelayan: [] };
  }
}

function generateAll(btn){
  const form = btn.closest("form");
  const resultBox = form.nextElementSibling;
  const formType = form.getAttribute('data-form-type');
  resultBox.innerHTML = "";

  // Ambil data form
  const formData = new FormData(form);
  const shipName = form.querySelector('input[type="text"]').value || "KAPAL";
  const date = form.querySelector('input[type="date"]').value || new Date().toISOString().split('T')[0];
  const time = form.querySelector('input[type="time"]').value || "00:00";
  const captain = form.querySelectorAll('input[type="text"]')[1].value || "KAPTEN";
  const gt = form.querySelectorAll('input[type="text"]')[2].value || "-";
  
  const formattedDate = date.replace(/-/g,'');
  const formattedTime = time.replace(':','');
  const code = `SANDAR-${shipName.replace(/\s+/g,'')}-${formattedDate}-${formattedTime}`;

  // Buat ringkasan dokumen
  const summaryDiv = document.createElement("div");
  summaryDiv.className = "document-summary";
  summaryDiv.innerHTML = `
    <h3>üìã Ringkasan Dokumen</h3>
    <table>
      <tr><td>Jenis Form:</td><td><strong>${formType}</strong></td></tr>
      <tr><td>Nama Kapal:</td><td>${shipName}</td></tr>
      <tr><td>Tanggal:</td><td>${new Date(date).toLocaleDateString('id-ID')}</td></tr>
      <tr><td>Waktu:</td><td>${time}</td></tr>
      <tr><td>Kapten:</td><td>${captain}</td></tr>
      <tr><td>GT:</td><td>${gt}</td></tr>
      <tr><td>Kode Dokumen:</td><td><strong>${code}</strong></td></tr>
      <tr><td>Dibuat:</td><td>${new Date().toLocaleString('id-ID')}</td></tr>
    </table>
  `;
  resultBox.appendChild(summaryDiv);

  // Buat QR Code dengan URL yang lebih sederhana dan mudah dibaca
  const qrSection = document.createElement("div");
  qrSection.className = "qr-section";
  qrSection.innerHTML = `<h3>üî≤ QR Code Dokumen</h3>`;
  
  const qrDiv = document.createElement("div");
  qrDiv.id = "qrcode-temp";
  qrSection.appendChild(qrDiv);
  
  // Format URL yang mudah dibaca - menggunakan query parameters
  const baseUrl = window.location.origin + window.location.pathname;
  const params = new URLSearchParams({
    code: code,
    type: formType,
    ship: shipName,
    date: date,
    time: time,
    captain: captain,
    gt: gt
  });
  const qrUrl = `${baseUrl}?${params.toString()}`;
  
  // Info QR untuk debug
  const qrInfo = document.createElement("div");
  qrInfo.className = "qr-info";
  qrInfo.innerHTML = `
    <p><strong>üîó URL QR Code:</strong></p>
    <div class="qr-url">${qrUrl}</div>
    <p><strong>üìè Panjang URL:</strong> ${qrUrl.length} karakter</p>
    <p><strong>üìä Error Correction:</strong> Medium (25%)</p>
    <button class="test-qr-btn" onclick="copyToClipboard('${qrUrl}')">üìã Copy URL</button>
    <button class="test-qr-btn" onclick="openUrl('${qrUrl}')">üîó Test URL</button>
  `;
  qrSection.appendChild(qrInfo);
  
  resultBox.appendChild(qrSection);
  
  // Generate QR dengan pengaturan optimal untuk keterbacaan
  new QRCode(qrDiv, {
    text: qrUrl,
    width: 256,
    height: 256,
    colorDark: "#2c3e50",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.M, // Medium error correction (25%)
    quietZone: 4,
    quietZoneColor: "#ffffff"
  });

  // Preview dokumen yang diupload
  let docCount = 0;
  form.querySelectorAll('input[type="file"]').forEach((fileInput, index) => {
    if(fileInput.files[0]){
      docCount++;
      const file = fileInput.files[0];
      const label = fileInput.parentElement.textContent.split(':')[0];
      
      const reader = new FileReader();
      reader.onload = function(e){
        const previewContainer = document.createElement("div");
        previewContainer.className="preview-container";
        
        // Info dokumen dengan keterangan form type
        const docInfo = document.createElement("div");
        docInfo.className = "document-info";
        docInfo.innerHTML = `
          <h4>${label}</h4>
          <p>üìÑ ${file.name} | üìè ${(file.size/1024).toFixed(2)} KB | üìÖ ${new Date().toLocaleDateString('id-ID')}<br>
          <strong>üìã Jenis: ${formType}</strong></p>
        `;
        previewContainer.appendChild(docInfo);
        
        // Preview file
        let previewEl;
        if(file.type.includes("pdf")){
          previewEl = document.createElement("embed");
          previewEl.src = e.target.result;
          previewEl.type = "application/pdf";
        } else if(file.type.includes("image")){
          previewEl = document.createElement("img");
          previewEl.src = e.target.result;
          previewEl.alt = file.name;
        } else {
          previewEl = document.createElement("div");
          previewEl.innerHTML = `<p style="text-align:center;padding:50px;color:#7f8c8d;">üìÑ ${file.name}<br><small>Preview tidak tersedia untuk tipe file ini</small></p>`;
        }
        previewContainer.appendChild(previewEl);

        // Download link dengan keterangan form type
        const downloadLink = document.createElement("a");
        downloadLink.href = e.target.result;
        downloadLink.download = `[${formType}]_${code}_${label}_${file.name}`;
        downloadLink.textContent = `‚¨á Download ${label}`;
        previewContainer.appendChild(downloadLink);

        resultBox.appendChild(previewContainer);
      };
      reader.readAsDataURL(file);
    }
  });
  
  if(docCount === 0){
    alert("Silakan upload minimal satu dokumen!");
  }
}

// Fungsi bantuan untuk QR Code
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    alert('URL berhasil disalin ke clipboard!');
  }).catch(function(err) {
    console.error('Gagal menyalin: ', err);
    // Fallback untuk browser lama
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('URL berhasil disalin ke clipboard!');
  });
}

function openUrl(url) {
  window.open(url, '_blank');
}

async function downloadAll(btn){
  const form = btn.closest("form");
  const resultBox = form.nextElementSibling;
  const formType = form.getAttribute('data-form-type');
  
  if(!resultBox.innerHTML.trim()){
    alert("Generate QR & Preview terlebih dahulu!");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  let yOffset = 20;
  let pageHeight = 297;
  let pageWidth = 210;
  let margin = 20;
  
  // Ambil data dari form
  const shipName = form.querySelector('input[type="text"]').value || "KAPAL";
  const date = form.querySelector('input[type="date"]').value || new Date().toISOString().split('T')[0];
  const time = form.querySelector('input[type="time"]').value || "00:00";
  const captain = form.querySelectorAll('input[type="text"]')[1].value || "KAPTEN";
  const gt = form.querySelectorAll('input[type="text"]')[2].value || "-";
  
  function checkAndAddPage(neededHeight) {
    if (yOffset + neededHeight > pageHeight - 35) { // Lebih banyak ruang untuk footer
      pdf.addPage();
      yOffset = 20;
      return true;
    }
    return false;
  }
  
  // Header PDF
  pdf.setFontSize(18);
  pdf.setFont(undefined, 'bold');
  pdf.text('SANDAR-RATU', pageWidth/2, yOffset, { align: 'center' });
  yOffset += 8;
  
  pdf.setFontSize(12);
  pdf.text('Sistem Administrasi & Dokumen Kesyahbandaran', pageWidth/2, yOffset, { align: 'center' });
  yOffset += 5;
  pdf.text('PPN Palabuhanratu', pageWidth/2, yOffset, { align: 'center' });
  yOffset += 20;
  
  // Form Type Indicator
  pdf.setDrawColor(52, 152, 219);
  pdf.setFillColor(232, 244, 248);
  pdf.roundedRect(margin, yOffset, pageWidth - 2*margin, 15, 3, 3, 'FD');
  
  yOffset += 10;
  pdf.setFontSize(14);
  pdf.setFont(undefined, 'bold');
  pdf.setTextColor(44, 62, 80);
  pdf.text('JENIS FORM: ' + formType, pageWidth/2, yOffset, { align: 'center' });
  yOffset += 15;
  
  // Info dokumen
  pdf.setDrawColor(100);
  pdf.setFillColor(245, 245, 245);
  pdf.roundedRect(margin, yOffset, pageWidth - 2*margin, 40, 3, 3, 'FD');
  
  yOffset += 10;
  pdf.setFontSize(12);
  pdf.setFont(undefined, 'bold');
  pdf.setTextColor(0);
  pdf.text('INFORMASI DOKUMEN', margin + 10, yOffset);
  yOffset += 8;
  
  pdf.setFontSize(10);
  pdf.setFont(undefined, 'normal');
  pdf.text('Nama Kapal: ' + shipName, margin + 10, yOffset);
  pdf.text('GT: ' + gt, margin + 100, yOffset);
  yOffset += 6;
  pdf.text('Tanggal: ' + new Date(date).toLocaleDateString('id-ID'), margin + 10, yOffset);
  pdf.text('Waktu: ' + time, margin + 100, yOffset);
  yOffset += 6;
  pdf.text('Kapten: ' + captain, margin + 10, yOffset);
  yOffset += 20;

  // QR Code
  const qrDiv = resultBox.querySelector('#qrcode-temp');
  if(qrDiv){
    const canvas = qrDiv.querySelector('canvas');
    if(canvas){
      checkAndAddPage(70);
      pdf.setFontSize(12);
      pdf.setFont(undefined, 'bold');
      pdf.text('QR CODE VERIFIKASI DOKUMEN', pageWidth/2, yOffset, { align: 'center' });
      yOffset += 10;
      
      const imgData = canvas.toDataURL('image/png');
      const qrSize = 50;
      pdf.addImage(imgData, 'PNG', (pageWidth-qrSize)/2, yOffset, qrSize, qrSize);
      yOffset += qrSize + 10;
      
      // Tambahkan URL QR di PDF
      const qrUrl = resultBox.querySelector('.qr-url').textContent;
      pdf.setFontSize(8);
      pdf.setFont(undefined, 'normal');
      pdf.text('Scan QR atau kunjungi:', pageWidth/2, yOffset, { align: 'center' });
      yOffset += 5;
      pdf.text(qrUrl, pageWidth/2, yOffset, { align: 'center' });
      yOffset += 15;
    }
  }

  // Daftar Dokumen
  checkAndAddPage(20);
  pdf.setFontSize(14);
  pdf.setFont(undefined, 'bold');
  pdf.text('DOKUMEN TERLAMPIR:', margin, yOffset);
  yOffset += 15;
  
  let docNumber = 1;
  const fileInputs = form.querySelectorAll('input[type="file"]');
  
  fileInputs.forEach((fileInput) => {
    if(fileInput.files[0]){
      const file = fileInput.files[0];
      const label = fileInput.parentElement.textContent.split(':')[0];
      
      checkAndAddPage(30);
      
      // Info dokumen dengan form type
      pdf.setFontSize(11);
      pdf.setFont(undefined, 'bold');
      pdf.text(docNumber + '. ' + label, margin, yOffset);
      yOffset += 6;
      
      pdf.setFontSize(9);
      pdf.setFont(undefined, 'normal');
      const fileInfo = file.name + ' | ' + (file.size/1024).toFixed(2) + ' KB';
      pdf.text(fileInfo, margin + 10, yOffset);
      yOffset += 4;
      
      pdf.setFontSize(8);
      pdf.setTextColor(41, 128, 185);
      pdf.text('Jenis Form: ' + formType, margin + 10, yOffset);
      pdf.setTextColor(0);
      yOffset += 8;
      
      // Box untuk preview
      pdf.setDrawColor(200);
      pdf.setFillColor(250, 250, 250);
      pdf.roundedRect(margin + 10, yOffset, pageWidth - 2*margin - 20, 15, 2, 2, 'FD');
      
      if(file.type.includes('pdf')){
        pdf.text('Dokumen PDF - ' + file.name, margin + 15, yOffset + 10);
      } else if(file.type.includes('image')){
        pdf.text('Gambar - ' + file.name, margin + 15, yOffset + 10);
      } else {
        pdf.text('File - ' + file.name, margin + 15, yOffset + 10);
      }
      
      yOffset += 20;
      docNumber++;
    }
  });
  
  // Footer
  const totalPages = pdf.internal.getNumberOfPages();
  for(let i = 1; i <= totalPages; i++) {
    pdf.setPage(i);
    pdf.setFontSize(8);
    pdf.setTextColor(100);
    
    const footerY = pageHeight - 15;
    pdf.text('SANDAR-RATU ¬© 2025', margin, footerY);
    pdf.text('Halaman ' + i + ' dari ' + totalPages, pageWidth/2, footerY, { align: 'center' });
    pdf.text('Dicetak: ' + new Date().toLocaleDateString('id-ID'), pageWidth - margin, footerY, { align: 'right' });
    
    // Form type di footer
    pdf.setFontSize(7);
    pdf.text('Form: ' + formType, pageWidth/2, footerY + 5, { align: 'center' });
  }
  
  // Save PDF dengan prefix form type
  const fileName = `[${formType}]_SANDAR_RATU_${shipName.replace(/\s+/g,'_')}_${date.replace(/-/g,'')}.pdf`;
  pdf.save(fileName);
  
  alert(`Dokumen PDF berhasil di-download: ${fileName}\nJenis Form: ${formType}\nJumlah dokumen: ${docNumber-1}`);
}

// Set tanggal hari ini sebagai default
document.addEventListener("DOMContentLoaded",()=>{
  const today = new Date().toISOString().split("T")[0];
  const now = new Date().toTimeString().slice(0,5);
  document.querySelectorAll('input[type="date"]').forEach(i=>i.value=today);
  document.querySelectorAll('input[type="time"]').forEach(i=>i.value=now);
  
  // Load storage data
  loadStorageData();
});

// Initialize storage if empty
if (!documentStorage) {
  documentStorage = { petugas: [], nelayan: [] };
}
